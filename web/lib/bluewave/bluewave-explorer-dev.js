if(!javaxt)var javaxt={};if(!javaxt.dhtml)javaxt.dhtml={};
if(!bluewave)var bluewave={};bluewave.Explorer=function(parent,config){this.className="bluewave.Explorer";var me=this;var defaultConfig={nodes:[{title:"Pie Chart",type:"pieChart",icon:"fas fa-chart-pie",editor:{width:1060,height:600,resizable:true,class:bluewave.editor.PieEditor},inputNodes:["datafile","filter","sankeyChart"]},{title:"Bar Chart",type:"barChart",icon:"fas fa-chart-bar",editor:{width:1060,height:600,resizable:true,class:bluewave.editor.BarEditor},inputNodes:["datafile","filter"]},{title:"Line Chart",type:"lineChart",icon:"fas fa-chart-line",editor:{width:1060,height:600,resizable:true,class:bluewave.editor.LineEditor},inputNodes:["datafile","filter"]},{title:"Histogram Chart",type:"histogramChart",icon:"fas fa-chart-area",editor:{width:1060,height:600,resizable:true,class:bluewave.editor.HistogramEditor},inputNodes:["datafile","filter"]},{title:"Scatter Chart",type:"scatterChart",icon:"fas fa-braille",editor:{width:1060,height:600,resizable:true,class:bluewave.editor.ScatterEditor},inputNodes:["datafile","filter"]},{title:"Map",type:"mapChart",icon:"fas fa-globe-americas",editor:{width:1180,height:700,resizable:true,class:bluewave.editor.MapEditor},inputNodes:["datafile","filter"]},{title:"Treemap Chart",type:"treeMapChart",icon:"fas fa-basketball-ball",editor:{width:1060,height:600,resizable:true,class:bluewave.editor.TreeMapEditor},inputNodes:["datafile","filter"]},{title:"Calendar Chart",type:"calendarChart",icon:"fas fa-th",editor:{width:1060,height:600,resizable:true,class:bluewave.editor.CalendarEditor},inputNodes:["datafile","filter"]},{title:"Sankey Chart",type:"sankeyChart",icon:"fas fa-random",editor:{width:1680,height:920,resizable:true,class:bluewave.editor.SankeyEditor}},{title:"Filter",type:"filter",icon:"fas fa-filter",editor:{width:1060,height:600,resizable:true,class:bluewave.editor.FilterEditor},inputNodes:["datafile"]}],toolbar:{nodes:["sankeyChart","pieChart","barChart","lineChart","histogramChart","scatterChart","mapChart","treeMapChart","calendarChart","filter"]},supportedFileTypes:["csv","tab","tsv","xls","xlsx","pdf"]};var id,name,description,thumbnail;var menubar,button={};var tooltip,tooltipTimer,lastToolTipEvent;var drawflow,nodes={};var waitmask;var windows=[];var zoom=0;var init=function(){me.setConfig(config);if(!parent)return;if(!config.fx)config.fx=new javaxt.dhtml.Effects();if(!config.style)config.style=javaxt.dhtml.style.default;waitmask=config.waitmask;if(!waitmask)waitmask={show:function(){},hide:function(){}};var div=createElement("div",parent,{height:"100%",position:"relative"});div.setAttribute("desc",me.className);div.onwheel=function(e){e.preventDefault();if(drawflow){if(e.deltaY>0){zoomOut();}
else{zoomIn();}}};div.tabIndex=-1;createDrawFlow(div);tooltip=new javaxt.dhtml.Callout(document.body,{style:{panel:"tooltip-panel",arrow:"tooltip-arrow"}});var _hideToolTip=tooltip.hide;tooltip.hide=function(){if(tooltipTimer)clearTimeout(tooltipTimer);_hideToolTip();};addShowHide(div);me.el=div;addShowHide(me);};this.onChange=function(event){};this.setConfig=function(chartConfig){if(!chartConfig)config=defaultConfig;else config=merge(chartConfig,defaultConfig);};this.getConfig=function(){return config;};this.addExtensions=function(extensions){if(extensions)extensions.forEach(function(extension){addExtension(extension);});};this.setName=function(str){name=str;};this.getName=function(){return name;};this.setID=function(i){id=i;};this.getID=function(){return id;};this.getDashboard=function(noInfo){var dashboard={id:id,name:name,description:description,className:me.className,thumbnail:thumbnail};if(noInfo===true)return;dashboard.info={layout:drawflow.export().drawflow.Home.data,nodes:{},zoom:zoom};for(var key in nodes){if(nodes.hasOwnProperty(key)){var node=nodes[key];dashboard.info.nodes[key]={name:node.name,type:node.type,config:node.config,preview:node.preview};if(node.type==="datafile"){if(node.data){dashboard.info.nodes[key].data=node.data;}}}};return dashboard;};this.getNodes=function(){return nodes;};this.clear=function(){id=name=description=thumbnail=null;nodes={};drawflow.clear();for(var buttonName in button){if(button.hasOwnProperty(buttonName)){button[buttonName].disable();}}
for(var i in windows){windows[i].hide();}
zoom=0;};this.update=function(dashboard,readOnly,callback){if(!dashboard)dashboard={};me.clear();id=dashboard.id;name=dashboard.name;description=dashboard.description;thumbnail=dashboard.thumbnail;drawflow.editor_mode=readOnly?"view":"edit";updateButtons();me.el.focus();if(!dashboard.info)return;drawflow.import({drawflow:{Home:{data:dashboard.info.layout}}});var thumbnails=[];var connectionNodes=[];for(var nodeID in dashboard.info.nodes){if(dashboard.info.nodes.hasOwnProperty(nodeID)){var drawflowNode=drawflow.getNodeFromId(nodeID);var temp=createElement("div");temp.innerHTML=drawflowNode.html;var node=document.getElementById(temp.childNodes[0].id);var props=dashboard.info.nodes[nodeID];for(var key in props){if(props.hasOwnProperty(key)){var val=props[key];node[key]=val;}}
if(node.type==="map")node.type="mapChart";if(props.config.chartTitle)updateTitle(node,props.config.chartTitle);if(props.preview)thumbnails.push({node:node,thumbnail:props.preview});addEventListeners(node);node.inputs={};for(var key in drawflowNode.inputs){if(drawflowNode.inputs.hasOwnProperty(key)){var connections=drawflowNode.inputs[key].connections;for(var i in connections){var connection=connections[i];var inputID=connection.node;var inputNode=nodes[inputID];node.inputs[inputID]=inputNode;connectionNodes.push(inputID);}}}
nodes[nodeID]=node;}}
for(var nodeID in nodes){var node=nodes[nodeID];for(var inputID in node.inputs){var inputNode=node.inputs[inputID];if(!inputNode)node.inputs[inputID]=nodes[inputID];}}
var filterEditors=[];for(var nodeID in nodes){var node=nodes[nodeID];if(node.type==="filter"){var editor=getNodeEditor(node);if(editor)filterEditors.push(editor);}}
var onReady=function(){updateButtons();setTimeout(function(){for(var i=0;i<connectionNodes.length;i++){var inputID=connectionNodes[i];drawflow.updateConnectionNodes("node-"+inputID);}
for(var i=0;i<thumbnails.length;i++){(function(t){var el=t.node.childNodes[1];onRender(el,function(){createThumbnail(t.node,t.thumbnail);});})(thumbnails[i]);}
setZoom(dashboard.info.zoom);me.el.focus();if(callback)callback.apply(me,[]);},500);};if(filterEditors.length===0){onReady();}
else{waitmask.show();var applyFilter=function(){if(filterEditors.length===0){waitmask.hide();onReady();return;}
var editor=filterEditors.shift();var node=editor.getNode();editor.update(node,function(){node.data=JSON.parse(JSON.stringify(editor.getData()));editor.clear();applyFilter();});};applyFilter();}};var updateButtons=function(){for(var key in button){if(button.hasOwnProperty(key)){button[key].disable();}}
if(me.isReadOnly())return;var visibleNodes={};for(var key in nodes){if(nodes.hasOwnProperty(key)){var node=nodes[key];visibleNodes[node.type]=true;}}
config.nodes.forEach(function(n){var menuButton=button[n.type];if(!menuButton)return;var inputNodes=n.inputNodes;if(!inputNodes)inputNodes=[];if(inputNodes.length>0){inputNodes.every(function(t){var hasValidNode=false;var required=true;if(typeof t==="string"){hasValidNode=visibleNodes[t];}
else{hasValidNode=visibleNodes[t.inputNode];required=t.required;}
if(hasValidNode){menuButton.enable();return false;}
else{if(!required)menuButton.enable();}
return true;});}
else{menuButton.enable();}});};this.setReadOnly=function(readOnly){if(readOnly===true){if(me.isReadOnly())return;drawflow.editor_mode="view";}
else{if(!me.isReadOnly())return;drawflow.editor_mode="edit";}
updateButtons();};this.isReadOnly=function(){return(drawflow.editor_mode==="view");};this.getToolbar=function(){return menubar;};this.getButtons=function(){return button;};var getFileNodes=function(){var fileNodes=[];for(var key in nodes){if(nodes.hasOwnProperty(key)){var node=nodes[key];if(isValidFile(node.type)){fileNodes.push(node);}}}
return fileNodes;};var createDrawFlow=function(parent){var div=createElement("div",parent,"drawflow");div.addEventListener('dragover',onDragOver,false);div.addEventListener('drop',onDrop,false);drawflow=new Drawflow(div);drawflow.reroute=true;drawflow.start();drawflow.on('connectionCreated',function(info){var outputID=info.output_id+"";var inputID=info.input_id+"";var node=nodes[inputID];var inputNode=nodes[outputID];var acceptConnection=false;config.nodes.every(function(n){if(n.type===node.type){var inputNodes=n.inputNodes;if(inputNodes){inputNodes.forEach(function(t){if(typeof t==="string"){if(inputNode.type===t){acceptConnection=true;}}
else{if(t.inputNode===inputNode.type){acceptConnection=true;}}});}
else{if(node.type==="layout")acceptConnection=true;}
return false;}
return true;});if(acceptConnection){node.inputs[outputID]=inputNode;node.ondblclick();}
else{drawflow.removeSingleConnection(info.output_id,info.input_id,info.output_class,info.input_class);}
me.onChange('connectionCreated');});drawflow.on('nodeRemoved',function(nodeID){removeInputs(nodes,nodeID);var nodeType=nodes[nodeID+""].type;delete nodes[nodeID+""];updateButtons();me.onChange('nodeRemoved');});drawflow.on('connectionRemoved',function(info){var outputID=info.output_id+"";var inputID=info.input_id+"";var node=nodes[inputID];delete node.inputs[outputID+""];me.onChange('connectionRemoved');});drawflow.on('contextmenu',function(e){setTimeout(function(){for(var key in nodes){if(nodes.hasOwnProperty(key)){var node=nodes[key];var parentNode=node.parentNode.parentNode;var deleteDiv=parentNode.getElementsByClassName("drawflow-delete")[0];if(deleteDiv){parentNode.removeChild(deleteDiv);deleteDiv=createElement("div",parentNode,"drawflow-delete2");deleteDiv.innerHTML="&#x2715";deleteDiv.nodeID=parseInt(key);deleteDiv.onclick=function(){var div=this;var nodeID=div.nodeID;confirm("Are you sure you want to delete this node?",{leftButton:{label:"Yes",value:true},rightButton:{label:"No",value:false},callback:function(yes){if(yes){drawflow.removeNodeId("node-"+nodeID);}
else{div.parentNode.removeChild(div);}}});};}}}},200);});drawflow.on('nodeMoved',function(nodeID){me.onChange('nodeMoved');});menubar=createElement("div",div,"drawflow-toolbar");config.toolbar.nodes.forEach((toolbarItem)=>{if(typeof toolbarItem==="string"){config.nodes.every((node)=>{if(toolbarItem===node.type){var btn=createMenuButton(node.type,node.icon,node.title);if(node.inputNodes){if(isArray(node.inputNodes)){if(node.inputNodes.length===0)btn.enable();;}}
else{btn.enable();}
return false;}
return true;});}
else if(isArray(toolbarItem)){}});};var setZoom=function(z){z=parseInt(z);if(isNaN(z)||z===zoom)return;var d=Math.abs(z,zoom);for(var i=0;i<d;i++){if(z<zoom){zoomOut();}
else{zoomIn();}}
me.onChange('zoomChange');};var zoomIn=function(){drawflow.zoom_in();zoom++;};var zoomOut=function(){drawflow.zoom_out();zoom--;};var drag=function(ev){if(ev.type==="touchstart"){}
else{ev.dataTransfer.setData("node",ev.target.getAttribute("data-node"));}};var onDragOver=function(e){e.stopPropagation();e.preventDefault();e.dataTransfer.dropEffect='copy';};var onDrop=function(e){e.stopPropagation();e.preventDefault();if(e.type==="touchend"){}
else{var x=e.clientX;var y=e.clientY;var files=e.dataTransfer.files;if(files.length>0){var existingFiles={};var fileNodes=getFileNodes();for(var i=0;i<fileNodes.length;i++){var fileNode=fileNodes[i];var fileName=fileNode.config.fileName;existingFiles[fileName.toLowerCase()]=fileNode;}
var arr=[];for(var i=0;i<files.length;i++){var file=files[i];if(isValidFile(file)){var fileName=file.name.toLowerCase();if(existingFiles[fileName]){}
else{arr.push(file);}}}
if(arr.length===0)return;var uploads=0;var failures=[];waitmask.show();var upload=function(){if(arr.length===0){waitmask.hide();if(failures.length>0){alert("Failed to upload "+failures);}
return;}
var file=arr.shift();var ext=getFileExtension(file);if(isValidFile(ext)){var formData=new FormData();formData.append(file.name,file);if(uploads>0){x+=35;y+=85;}
uploads++;addNodeToDrawFlow(ext,x,y,file);upload();}};upload();if(uploads>0)updateButtons();}
else{let nodeType=e.dataTransfer.getData("node");addNodeToDrawFlow(nodeType,x,y);}}};var addNodeToDrawFlow=function(nodeType,pos_x,pos_y,file){if(drawflow.editor_mode==="fixed")return false;pos_x=pos_x*(drawflow.precanvas.clientWidth/(drawflow.precanvas.clientWidth*drawflow.zoom))-
drawflow.precanvas.getBoundingClientRect().x*(drawflow.precanvas.clientWidth/(drawflow.precanvas.clientWidth*drawflow.zoom));pos_y=pos_y*(drawflow.precanvas.clientHeight/(drawflow.precanvas.clientHeight*drawflow.zoom))-
drawflow.precanvas.getBoundingClientRect().y*(drawflow.precanvas.clientHeight/(drawflow.precanvas.clientHeight*drawflow.zoom));var nodeConfig=getNodeConfig(nodeType);if(!nodeConfig){console.log("Unsupported Node Type: "+nodeType);return;}
if(file){nodeConfig.type="datafile";nodeConfig.title=file.name;}
nodeType=nodeConfig.type;var icon=nodeConfig.icon;var title=nodeConfig.title;var inputs=0;var outputs=1;if(nodeConfig.inputNodes){if(isArray(nodeConfig.inputNodes)){if(nodeConfig.inputNodes.length>0)inputs=1;}}
if(nodeType==="layout")outputs=0;var node=createNode({name:title,type:nodeType,icon:icon,content:createElement("i",icon),position:[pos_x,pos_y],inputs:inputs,outputs:outputs});addEventListeners(node);me.onChange('nodeCreated');if(file){node.file=file;node.config.fileName=file.name;node.ondblclick();}};var addEventListeners=function(node){node.ondblclick=function(){var editor=getNodeEditor(node);if(editor){editor.clear();editor.show();var delay=editor.getData?300:50;setTimeout(()=>{editor.update(node);},delay);}};};var createNode=function(node){var div=createElement("div");div.id="_"+new Date().getTime();var title=createElement("div",div,"drawflow-node-title");title.innerHTML="<i class=\""+node.icon+"\"></i><span>"+node.name+"</span>";var body=createElement("div",div,"drawflow-node-body");var content=node.content;if(content){if(typeof content==="string"){body.innerHTML=content;}
else{body.appendChild(content);}}
var nodeID=drawflow.addNode(node.type,node.inputs,node.outputs,node.position[0],node.position[1],"",{},div.outerHTML);div=document.getElementById(div.id);div.type=node.type;div.inputs={};div.config={};nodes[nodeID+""]=div;return div;};var getNodeConfig=function(nodeType){var nodeConfig;config.nodes.every((n)=>{if(n.type===nodeType){nodeConfig=n;return false;}
return true;});if(!nodeConfig&&(nodeType==="datafile"||isValidFile(nodeType))){switch(nodeType){case"csv":case"xls":case"xlsx":case"datafile":var icon="fas fa-file-alt";if(nodeType==="csv"){icon="fas fa-file-csv";}
if(nodeType==="xls"||nodeType==="xlsx"){icon="fas fa-file-excel";}
nodeConfig={title:nodeType+" Data",icon:icon,editor:{width:1060,height:600,resizable:true,class:bluewave.editor.CsvEditor}};break;case"pdf":var icon="fas fa-file-pdf";break;}}
return nodeConfig;};var getNodeEditor=function(node){var nodeConfig=getNodeConfig(node.type);if(!nodeConfig)return;var editor=nodeConfig.editor;if(editor.class){if(node.type==="datafile"){editor.title=node.config.fileName;}
editor=createNodeEditor(editor);nodeConfig.editor=editor;if(editor.onSave||editor.onChange){var save=function(){if(me.isReadOnly())return;var chartConfig=editor.getConfig();var node=editor.getNode();node.config=JSON.parse(JSON.stringify(chartConfig));me.onChange('nodeUpdated');};if(editor.onSave){editor.onSave=function(){save();};}
if(editor.onChange){editor.onChange=function(){save();};}}}
editor.getNode=function(){return node;};if(editor.getData){var _update=editor.update;editor.update=function(node,callback){_update(node,callback);node.data=JSON.parse(JSON.stringify(editor.getData()));};}
return editor;};var createNodeEditor=function(editorConfig){merge(editorConfig,{title:"Edit Chart",width:1060,height:600,resizable:false,beforeClose:null,style:config.style});var style=merge({body:{padding:"0px"},closeIcon:{content:"&#x2715;",lineHeight:"16px",textAlign:"center"}},config.style.window);var win=createWindow({title:editorConfig.title,width:editorConfig.width,height:editorConfig.height,modal:true,resizable:editorConfig.resizable,shrinkToFit:true,style:style,renderers:{headerButtons:function(buttonDiv){var btn=createElement('div',buttonDiv,style.button);createElement('div',btn,style.closeIcon);btn.onclick=function(){if(editorConfig.beforeClose){editorConfig.beforeClose.apply(me,[win]);}
else{var editor=win.editor;var node=editor.getNode();if(editor.getData)node.data=editor.getData();var chartConfig=editor.getConfig();var orgConfig=node.config;if(!orgConfig)orgConfig={};if(isDirty(chartConfig,orgConfig)){me.onChange('nodeUpdated');node.config=JSON.parse(JSON.stringify(chartConfig));updateTitle(node,node.config.chartTitle);if(editor.getChart){waitmask.show();var el=editor.getChart();if(el.show)el.show();setTimeout(function(){createPreview(el,function(canvas){if(canvas&&canvas.toDataURL){node.preview=canvas.toDataURL("image/png");me.onChange('nodeUpdated');createThumbnail(node,canvas);}
win.close();editor.clear();waitmask.hide();},this);},800);}
else{win.close();editor.clear();}}
else{updateTitle(node,node.config.chartTitle);win.close();editor.clear();}}};}}});if(editorConfig.class){if(typeof editorConfig.class==="string"){editorConfig.class=eval(editorConfig.class);}
var editor=new editorConfig.class(win.getBody(),editorConfig);editor.show=function(){win.show();};editor.hide=function(){win.hide();};win.onResize=function(){if(editor.resize)editor.resize();};win.editor=editor;return editor;}};var updateTitle=function(node,title){if(title){node.childNodes[0].getElementsByTagName("span")[0].innerHTML=title;}};var removeInputs=function(nodes,nodeID){for(var key in nodes){if(nodes.hasOwnProperty(key)){var node=nodes[key];for(var inputID in node.inputs){if(inputID===nodeID){delete node.inputs[nodeID+""];}}}}};var createWindow=function(config){var win=new javaxt.dhtml.Window(document.body,config);windows.push(win);return win;};var createPreview=function(el,callback,scope){html2canvas(el).then((canvas)=>{if(callback)callback.apply(scope,[canvas]);}).catch(function(error){if(callback)callback.apply(scope,["Preview Failed: "+error]);});};var createThumbnail=function(node,obj){var el=node.childNodes[1];el.innerHTML="";var rect=javaxt.dhtml.utils.getRect(el);var width=rect.width;var height=rect.height;var div=createElement('div',el,{width:"100%",height:"100%"});var rect=javaxt.dhtml.utils.getRect(div);el.innerHTML="";var padding=width-rect.width;var maxWidth=width-padding;var maxHeight=height-padding;var width=0;var height=0;var setWidth=function(){var ratio=maxWidth/width;width=width*ratio;height=height*ratio;};var setHeight=function(){var ratio=maxHeight/height;width=width*ratio;height=height*ratio;};var resize=function(canvas){width=canvas.width;height=canvas.height;if(maxHeight<maxWidth){setHeight();if(width>maxWidth)setWidth();}
else{setWidth();if(height>maxHeight)setHeight();}
if(width===0||height===0)return;resizeCanvas(canvas,width,height,true);var base64image=canvas.toDataURL("image/png");var img=createElement("img","noselect");img.onload=function(){el.appendChild(this);};img.src=base64image;img.ondragstart=function(e){e.preventDefault();};};if(typeof obj==="string"){var img=createElement('img');img.onload=function(){var img=this;var canvas=createElement('canvas');canvas.width=img.width;canvas.height=img.height;var ctx=canvas.getContext("2d");ctx.drawImage(img,0,0);resize(canvas);};img.src=obj;}
else{resize(obj);}};var createMenuButton=function(nodeType,icon,title){var btn=new javaxt.dhtml.Button(menubar,{display:"table",disabled:true,style:{button:"drawflow-toolbar-button",select:"drawflow-toolbar-button-selected",hover:"drawflow-toolbar-button-hover",label:"drawflow-toolbar-button-label",icon:"drawflow-toolbar-button-icon "+icon}});btn.el.dataset["node"]=nodeType;btn.el.dataset["icon"]=icon;btn.el.dataset["title"]=title;btn.el.draggable=true;btn.el.ondragstart=function(e){if(btn.isDisabled()){return false;}
drag(e);};btn.el.onmouseover=function(e){var button=this;if(tooltipTimer)clearTimeout(tooltipTimer);if(btn.isEnabled()){var showToolTip=function(){var nodeType=button.dataset["node"];var title=button.dataset["title"];var label="Add "+(title==null?nodeType:title);tooltip.getInnerDiv().innerHTML=label;var rect=javaxt.dhtml.utils.getRect(button);var rect2=javaxt.dhtml.utils.getRect(button.parentNode);var x=rect2.x+rect2.width+3;var y=rect.y+Math.ceil(rect.height/2);tooltip.showAt(x,y,"right","center");lastToolTipEvent=new Date().getTime();};var delay=false;if(lastToolTipEvent){if(new Date().getTime()-lastToolTipEvent<3000)delay=false;}
if(delay){tooltipTimer=setTimeout(showToolTip,1000);}
else{showToolTip();}}};btn.el.onmouseleave=function(){tooltip.hide();};btn.el.onmousedown=function(){tooltip.hide();};button[nodeType]=btn;return btn;};var addExtension=function(extension){if(extension.type==="editor"&&extension.node){addEditor(extension.node);}};var addEditor=function(node){var hasNode=false;config.nodes.forEach(function(n){if(n.type===node.type){hasNode=true;}});if(!hasNode){if(node.editor.class){config.nodes.push(node);}
else{console.log("Failed to load "+node.title);return;}}
if(!button[node.type]){createMenuButton(node.type,node.icon,node.title);}};var getFileExtension=function(file){var fileName=file.name.toLowerCase();var ext=fileName.substring(fileName.lastIndexOf(".")+1);return ext;};var isValidFile=function(f){var ext;if(typeof f==="string"){ext=f;}
else{ext=getFileExtension(f);}
var foundMatch=false;for(var i=0;i<config.supportedFileTypes.length;i++){if(config.supportedFileTypes[i]===ext){foundMatch=true;break;}}
return foundMatch;};var merge=javaxt.dhtml.utils.merge;var onRender=javaxt.dhtml.utils.onRender;var isDirty=javaxt.dhtml.utils.isDirty;var isArray=javaxt.dhtml.utils.isArray;var addShowHide=javaxt.dhtml.utils.addShowHide;var createElement=javaxt.dhtml.utils.createElement;var resizeCanvas=bluewave.utils.resizeCanvas;init();};
if(!bluewave)var bluewave={};bluewave.utils={get:function(url,config){var payload=null;if(arguments.length>2){payload=arguments[1];config=arguments[2];}
var get=javaxt.dhtml.utils.get;get(url,{payload:payload,success:function(response){var s=response.substring(0,1);if(s=="{"||s=="["){var json=JSON.parse(response);if(json.cols&&json.rows){var rows=json.rows;var cols={};for(var i=0;i<json.cols.length;i++){cols[json.cols[i]]=i;}
for(var i=0;i<rows.length;i++){var row=rows[i];var obj={};for(var col in cols){if(cols.hasOwnProperty(col)){obj[col]=row[cols[col]];}}
rows[i]=obj;}
json=rows;}
response=json;}
if(config.success)config.success.apply(this,[response]);},failure:function(request){if(config.failure)config.failure.apply(this,[request]);}});},getData:function(name,path,callback){if(!bluewave.data)bluewave.data={};if(arguments.length>1){if(typeof arguments[1]==='function'){callback=arguments[1];path="data/";}}
var idx=path.lastIndexOf("/");if(idx!==path.length-1){path+="/";}
var url=path+name;var get=javaxt.dhtml.utils.get;var update=function(json){if(callback)callback.apply(this,[json]);};get(url,{success:function(text){if(text.indexOf("{")==0||text.indexOf("[")==0){update(JSON.parse(text));}
else{update(text);}},failure:function(){var idx=name.indexOf("?");if(idx>-1)name=name.substring(0,idx);if(bluewave.data[name]){update(bluewave.data[name]);}
else{var script=document.createElement("script");script.setAttribute("type","text/javascript");script.setAttribute("src",url+".js?_="+new Date().getTime());script.onload=function(){update(bluewave.data[name]);};var head=document.getElementsByTagName("head")[0];head.appendChild(script);}}});},getMapData:function(path,callback){if(arguments.length===0)return;if(typeof arguments[0]==='function'){callback=arguments[0];path="data/";}
var getData=bluewave.utils.getData;if(!bluewave.data)bluewave.data={};if(!bluewave.data.mapData)bluewave.data.mapData={};var counties=bluewave.data.mapData.counties;var countries=bluewave.data.mapData.countries;if(counties){if(countries)callback.apply(this,[bluewave.data.mapData]);else{getData("countries",path,function(countryData){countries=topojson.feature(countryData,countryData.objects.countries);bluewave.data.mapData.countries=countries;callback.apply(this,[bluewave.data.mapData]);});}}
else{getData("counties",path,function(countyData){counties=topojson.feature(countyData,countyData.objects.counties);bluewave.data.mapData.counties=counties;var states=topojson.feature(countyData,countyData.objects.states);bluewave.data.mapData.states=states;if(countries)callback.apply(this,[bluewave.data.mapData]);else{getData("countries",path,function(countryData){countries=topojson.feature(countryData,countryData.objects.countries);bluewave.data.mapData.countries=countries;callback.apply(this,[bluewave.data.mapData]);});}});}},warn:function(msg,field){var tr=field.row;var td;if(tr){td=tr.childNodes[2];}else{td=field.el.parentNode;}
if(td==null){td=field.el.parentNode;}
var getRect=javaxt.dhtml.utils.getRect;var rect=getRect(td);var inputs=td.getElementsByTagName("input");if(inputs.length==0)inputs=td.getElementsByTagName("textarea");if(inputs.length>0){inputs[0].blur();var cls="form-input-error";if(inputs[0].className){if(inputs[0].className.indexOf(cls)==-1)inputs[0].className+=" "+cls;}
else{inputs[0].className=cls;}
rect=getRect(inputs[0]);field.resetColor=function(){if(inputs[0].className){inputs[0].className=inputs[0].className.replace(cls,"");}};}
var callout=bluewave.utils.formError;if(!callout){callout=new javaxt.dhtml.Callout(document.body,{style:{panel:"error-callout-panel",arrow:"error-callout-arrow"}});bluewave.utils.formError=callout;}
callout.getInnerDiv().innerHTML=msg;var x=rect.x+(rect.width/2);var y=rect.y;callout.showAt(x,y,"above","center");},createButton:function(toolbar,btn){btn=JSON.parse(JSON.stringify(btn));if(btn.icon){btn.style.icon="toolbar-button-icon "+btn.icon;delete btn.icon;}
if(btn.menu===true){btn.style.arrow="toolbar-button-menu-icon";btn.style.menu="menu-panel";btn.style.select="panel-toolbar-menubutton-selected";}
return new javaxt.dhtml.Button(toolbar,btn);},createSpacer:function(toolbar){var div=document.createElement("div");div.className="toolbar-spacer";toolbar.appendChild(div);},createToggleButton:function(parent,config){var defaultConfig={style:{panel:"toggle-button-bar noselect",button:"toggle-button",activeButton:"toggle-button-active"}};javaxt.dhtml.utils.merge(config,defaultConfig);var div=document.createElement("div");div.className=config.style.panel;parent.appendChild(div);var onClick=function(btn,silent){if(btn.className===config.style.activeButton)return;div.reset();btn.className=config.style.activeButton;if(silent===true)return;if(config.onChange)config.onChange.apply(btn,[btn.innerHTML]);};for(var i=0;i<config.options.length;i++){var btn=document.createElement("div");btn.className=config.style.button;btn.innerHTML=config.options[i];btn.onclick=function(){onClick(this);};div.appendChild(btn);}
div.setValue=function(val,silent){for(var i=0;i<div.childNodes.length;i++){var btn=div.childNodes[i];if(btn.innerText===val){onClick(btn);break;}}};div.getValue=function(){for(var i=0;i<div.childNodes.length;i++){var btn=div.childNodes[i];if(btn.className===config.style.activeButton){return btn.innerText;}}
return null;};div.reset=function(){for(var i=0;i<div.childNodes.length;i++){div.childNodes[i].className=config.style.button;}};return div;},createDashboardItem:function(parent,config){var defaultConfig={width:360,height:260,title:"",subtitle:"",settings:false,waitmask:false};javaxt.dhtml.utils.merge(config,defaultConfig);var width=config.width+"";var height=config.height+"";if(width.indexOf("%")===-1)width=parseInt(width)+"px";if(height.indexOf("%")===-1)height=parseInt(height)+"px";var div=document.createElement("div");div.className="dashboard-item";div.style.width=width;div.style.height=height;div.style.position="relative";parent.appendChild(div);var settings;if(config.settings===true){settings=document.createElement("div");settings.className="dashboard-item-settings noselect";settings.innerHTML='<i class="fas fa-cog"></i>';div.appendChild(settings);}
var table=javaxt.dhtml.utils.createTable();var tbody=table.firstChild;var tr;tr=document.createElement("tr");tbody.appendChild(tr);var title=document.createElement("td");title.className="chart-title noselect";title.innerHTML=config.title;tr.appendChild(title);tr=document.createElement("tr");tbody.appendChild(tr);var subtitle=document.createElement("td");subtitle.className="chart-subtitle noselect";subtitle.innerHTML=config.subtitle;tr.appendChild(subtitle);tr=document.createElement("tr");tbody.appendChild(tr);var innerDiv=document.createElement("td");innerDiv.style.height="100%";innerDiv.style.position="relative";tr.appendChild(innerDiv);div.appendChild(table);var waitmask;if(config.waitmask){waitmask=new javaxt.express.WaitMask(div);}
return{el:div,title:title,subtitle:subtitle,innerDiv:innerDiv,settings:settings,waitmask:waitmask};},createGrid:function(records,hasHeader,gridContainer,config){gridContainer.innerHTML="";var columnConfig=[];var w=javaxt.dhtml.utils.getSuggestedColumnWidths(records,10);var columns=records[0];for(var i=0;i<columns.length;i++){var columnWidth=w.suggestedWidths[i];var minWidth=null;if(columnWidth==="100%"&&columns.length>1){minWidth=Math.min(w.widths[i],175);}
columnConfig.push({header:hasHeader?columns[i]:(i+1),width:columnWidth,minWidth:minWidth,sortable:false});}
var outerDiv=document.createElement("div");outerDiv.style.height="100%";outerDiv.style.position="relative";gridContainer.appendChild(outerDiv);var innerDiv=document.createElement("div");innerDiv.style.width="100%";innerDiv.style.height="100%";innerDiv.style.position="absolute";innerDiv.style.overflow="hidden";innerDiv.style.overflowX="auto";outerDiv.appendChild(innerDiv);var overflowDiv=document.createElement("div");overflowDiv.style.width="100%";overflowDiv.style.height="100%";overflowDiv.style.position="absolute";innerDiv.appendChild(overflowDiv);var headerWidth=w.headerWidth;javaxt.dhtml.utils.onRender(innerDiv,function(){var rect=javaxt.dhtml.utils.getRect(innerDiv);if(rect.width<headerWidth){overflowDiv.style.width=headerWidth+"px";}});var grid=new javaxt.dhtml.DataGrid(overflowDiv,{columns:columnConfig,style:config.style.table});if(hasHeader){var data=[];for(var i=1;i<records.length;i++){data.push(records[i]);}
grid.load(data,1);}
else{grid.load(records,1);}
return grid;},addTextEditor:function(div,callback){var setTitle=function(title){if(callback)callback.apply(div,[title]);};div.onclick=function(e){if(this.childNodes[0].nodeType===1)return;e.stopPropagation();var currText=this.innerText;this.innerHTML="";var input=document.createElement("input");input.className="form-input";input.type="text";input.value=currText;input.onkeydown=function(event){var key=event.keyCode;if(key===9||key===13){setTitle(this.value);}};this.appendChild(input);input.focus();};document.body.addEventListener('click',function(e){var input=div.childNodes[0];var className=e.target.className;if(input.nodeType===1&&className!="form-input"){setTitle(input.value);};});},createSlider:function(inputName,form,endCharacter="",min=0,max=100,interval=5){var input=form.findField(inputName);var row=input.row.cloneNode(true);var cols=row.childNodes;for(var i=0;i<cols.length;i++){cols[i].innerHTML="";}
input.row.parentNode.insertBefore(row,input.row.nextSibling);row.style.height="20px";var slider=document.createElement("input");cols[2].appendChild(slider);slider.type="range";slider.className="dashboard-slider";min=parseInt(min);if(min<0)min=0;max=parseInt(max);if(max<min)max=100;interval=parseInt(interval);if(interval<1)interval=1;max=Math.ceil(max/interval);slider.setAttribute("min",min+1);slider.setAttribute("max",max+1);slider.onchange=function(){var val=(this.value-1)*interval;input.setValue(val);};var isNumber=javaxt.dhtml.utils.isNumber;var round=javaxt.dhtml.utils.round;var setValue=input.setValue;input.setValue=function(val){val=parseFloat(val);setValue(val+`${endCharacter}`);slider.value=round(val/interval)+1;};var getValue=input.getValue;input.getValue=function(){var val=parseFloat(getValue());if(isNumber(val))return round(val,0);else return 0;};input.row.getElementsByTagName("input")[0].addEventListener('input',function(e){var val=parseFloat(this.value);if(isNumber(val)){if(val<0)val=0;input.setValue(val);}});return slider;},createColorOptions:function(inputName,form,onClick){var colorField=form.findField(inputName);var colorPreview=colorField.getButton();colorPreview.className=colorPreview.className.replace("pulldown-button-icon","");colorPreview.style.boxShadow="none";colorPreview.setColor=function(color){colorPreview.style.backgroundColor=color;};colorField.setValue=function(color){colorPreview.setColor(color);colorField.getInput().value=color;form.onChange(colorField,color);};colorField.getValue=function(){return colorField.getInput().value;};colorPreview.onclick=function(){if(onClick)onClick.apply(this,[colorField]);};},formatNumber:function(x){if(x==null)return"";if(typeof x!=="string")x+="";var parts=x.toString().split(".");parts[0]=parts[0].replace(/\B(?=(\d{3})+(?!\d))/g,",");return parts.join(".");},getStyleEditor:function(config){if(!bluewave.utils.styleEditor){bluewave.utils.styleEditor=new javaxt.dhtml.Window(document.body,{title:"Edit Style",width:400,valign:"top",modal:false,resizable:false,style:config.style.window});}
return bluewave.utils.styleEditor;},getColorPalette:function(fixedColors){if(fixedColors===true)
return["#6699CC","#98DFAF","#FF3C38","#FF8C42","#933ed5","#bebcc1","#9DBEDE","#C6EDD3","#FF8280","#FFB586","#cda5eb","#dedde0"];return[...["#C6EDD3","#98DFAF","#FF8280","#FF3C38","#FFB586","#FF8C42","#9DBEDE","#6699CC","#999999"],...d3.schemeCategory10];},getThemeColors:function(){return{blue:"#6699CC",green:"#98DFAF",red:"#FF3C38",orange:"#FF8C42",purple:"#933ed5",grey:"#bebcc1"};},getColorGradients:function(){var gradients={};var colors=bluewave.utils.getThemeColors();for(var key in colors){if(colors.hasOwnProperty(key)){var color=colors[key];gradients[key]=[color,"#f8f8f8"];if(key=='blue')gradients.blue=d3.schemeBlues[7].reverse();if(key=='red')gradients.red=d3.schemeReds[7].reverse();if(key=='green')gradients.green=d3.schemeGreens[7].reverse();if(key=='grey')gradients.grey=d3.schemeGreys[7].reverse();if(key=='purple')gradients.purple=d3.schemePurples[7].reverse();}}
var inferno=[];var plasma=[];for(var i=0;i<=10;i++){var x=i/10;inferno.push(d3.interpolateInferno(x));plasma.push(d3.interpolatePlasma(x));}
gradients.inferno=inferno.reverse();gradients.plasma=plasma.reverse();gradients.mixed=Object.values(colors);gradients.d3=d3.schemeCategory10;gradients.tableau=d3.schemeTableau10;return gradients;},createColorField:function(parent,config){if(arguments.length===0){parent=document.createElement("div");}
else if(arguments.length===1){if(!javaxt.dhtml.utils.isElement(parent)){config=parent;parent=document.createElement("div");}}
if(!config)config={};var defaultConfig={style:javaxt.dhtml.style.default};javaxt.dhtml.utils.merge(config,defaultConfig);var colorField=new javaxt.dhtml.ComboBox(parent,{style:config.style.combobox,readOnly:true,addNewOption:false,addNewOptionText:"Add New...",showMenuOnFocus:true});var defaultValue;if(!config.colors)config.colors=bluewave.utils.getColorGradients();for(var key in config.colors){if(config.colors.hasOwnProperty(key)){var colors=config.colors[key];var colorRange=chroma.scale(colors);var menuItem=document.createElement("div");menuItem.className="form-input-menu-color"
var background="linear-gradient(to right";for(var i=0;i<colors.length;i++){var p=javaxt.dhtml.utils.round((i/(colors.length-1)),2);var c=colorRange(p).css();background+=", "+c+" "+(p*100)+"%";}
background+=")";menuItem.style.background=background;colorField.add(menuItem,JSON.stringify(colors));if(!defaultValue)defaultValue=key;}}
var _setValue=colorField.setValue;colorField.setValue=function(color){if(typeof color==='string'||color instanceof String){_setValue(color);}
else{_setValue(JSON.stringify(color));}};return colorField;},createColorPicker:function(parent,config){if(!config)config={};if(!config.style)config.style=javaxt.dhtml.style.default;var colors=config.colors;if(!colors)colors=bluewave.utils.getColorPalette(true);var colorPicker={onChange:function(c){},setColor:function(c){},colorWheel:null,setColors:function(arr){}};var table=javaxt.dhtml.utils.createTable();var tbody=table.firstChild;var tr,td;tr=document.createElement("tr");tbody.appendChild(tr);td=document.createElement("td");tr.appendChild(td);var checkbox=document.createElement("div");checkbox.innerHTML='<i class="fas fa-check"></i>';var div=document.createElement("div");div.className="color-picker-header";div.innerHTML="Theme Colors";td.appendChild(div);var themeColors=td;var blocks=[];colorPicker.setColors=function(colors){blocks.forEach((block)=>{var p=block.parentNode;p.removeChild(block);});blocks=[];colors.forEach((c)=>{div=document.createElement("div");div.className="color-picker-option";div.style.backgroundColor=c;div.onclick=function(){if(checkbox.parentNode===this)return;if(checkbox.parentNode)checkbox.parentNode.removeChild(checkbox);this.appendChild(checkbox);colorPicker.onChange(new iro.Color(this.style.backgroundColor).hexString);};themeColors.appendChild(div);blocks.push(div);});};colorPicker.setColors(colors);tr=document.createElement("tr");tbody.appendChild(tr);td=document.createElement("td");tr.appendChild(td);var div=document.createElement("div");div.className="color-picker-header noselect";div.innerHTML="Custom Colors";td.appendChild(div);var createNewColor=function(){div=document.createElement("div");div.className="color-picker-option";div.onclick=function(){if(checkbox.parentNode===this)return;if(this.innerHTML===""){if(checkbox.parentNode)checkbox.parentNode.removeChild(checkbox);this.appendChild(checkbox);colorPicker.onChange(new iro.Color(this.style.backgroundColor).hexString);return;}
if(!colorPicker.colorWheel){var callout=new javaxt.dhtml.Callout(document.body,{style:{panel:"color-picker-callout-panel",arrow:"color-picker-callout-arrow"}});var innerDiv=callout.getInnerDiv();innerDiv.style.padding="5px";innerDiv.style.backgroundColor="#fff";var cp=new iro.ColorPicker(innerDiv,{width:280,height:280,anticlockwise:true,borderWidth:1,borderColor:"#fff",css:{"#output":{"background-color":"$color"}}});colorPicker.colorWheel=callout;colorPicker.colorWheel.getColor=function(){return cp.color.hexString;};cp.on("color:change",function(c){var div=colorPicker.colorWheel.target;div.innerHTML="";div.style.backgroundColor=colorPicker.colorWheel.getColor();});}
var div=this;var rect=javaxt.dhtml.utils.getRect(div);var x=rect.x+rect.width+5;var y=rect.y+(rect.height/2);colorPicker.colorWheel.target=div;colorPicker.colorWheel.showAt(x,y,"right","middle");colorPicker.colorWheel.onHide=function(){if(table.getElementsByClassName("color-picker-new-option").length>0)return;createNewColor();};};td.appendChild(div);var innerDiv=document.createElement("div");innerDiv.className="color-picker-new-option";innerDiv.innerHTML="<i class=\"fas fa-plus\"></i>";div.appendChild(innerDiv);};createNewColor();parent.appendChild(table);return colorPicker;},createColorPickerCallout:function(config){var popup=new javaxt.dhtml.Callout(document.body,{style:{panel:"color-picker-callout-panel",arrow:"color-picker-callout-arrow"}});var innerDiv=popup.getInnerDiv();var title="Select Color";var titleDiv=document.createElement("div");titleDiv.className="window-header";titleDiv.innerHTML="<div class=\"window-title\">"+title+"</div>";innerDiv.appendChild(titleDiv);var contentDiv=document.createElement("div");contentDiv.style.padding="0 15px 15px";contentDiv.style.width="325px";contentDiv.style.backgroundColor="#fff";innerDiv.appendChild(contentDiv);var table=javaxt.dhtml.utils.createTable();var tbody=table.firstChild;var tr=document.createElement('tr');tbody.appendChild(tr);var td=document.createElement('td');tr.appendChild(td);var cp=bluewave.utils.createColorPicker(td,config);popup.onHide=function(){if(cp.colorWheel&&cp.colorWheel.isVisible()){cp.colorWheel.hide();popup.show();}};popup.onChange=function(color){};popup.setColor=function(color){cp.setColor(color);};popup.setColors=function(colors){cp.setColors(colors);};cp.onChange=function(color){popup.onChange(color);};contentDiv.appendChild(table);return popup;},resizeCanvas:function(canvas,width,height,resize_canvas){var width_source=canvas.width;var height_source=canvas.height;width=Math.round(width);height=Math.round(height);var ratio_w=width_source/width;var ratio_h=height_source/height;var ratio_w_half=Math.ceil(ratio_w/2);var ratio_h_half=Math.ceil(ratio_h/2);var ctx=canvas.getContext("2d");var img=ctx.getImageData(0,0,width_source,height_source);var img2=ctx.createImageData(width,height);var data=img.data;var data2=img2.data;for(var j=0;j<height;j++){for(var i=0;i<width;i++){var x2=(i+j*width)*4;var weight=0;var weights=0;var weights_alpha=0;var gx_r=0;var gx_g=0;var gx_b=0;var gx_a=0;var center_y=(j+0.5)*ratio_h;var yy_start=Math.floor(j*ratio_h);var yy_stop=Math.ceil((j+1)*ratio_h);for(var yy=yy_start;yy<yy_stop;yy++){var dy=Math.abs(center_y-(yy+0.5))/ratio_h_half;var center_x=(i+0.5)*ratio_w;var w0=dy*dy;var xx_start=Math.floor(i*ratio_w);var xx_stop=Math.ceil((i+1)*ratio_w);for(var xx=xx_start;xx<xx_stop;xx++){var dx=Math.abs(center_x-(xx+0.5))/ratio_w_half;var w=Math.sqrt(w0+dx*dx);if(w>=1){continue;}
weight=2*w*w*w-3*w*w+1;var pos_x=4*(xx+yy*width_source);gx_a+=weight*data[pos_x+3];weights_alpha+=weight;if(data[pos_x+3]<255)
weight=weight*data[pos_x+3]/250;gx_r+=weight*data[pos_x];gx_g+=weight*data[pos_x+1];gx_b+=weight*data[pos_x+2];weights+=weight;}}
data2[x2]=gx_r/weights;data2[x2+1]=gx_g/weights;data2[x2+2]=gx_b/weights;data2[x2+3]=gx_a/weights_alpha;}}
if(resize_canvas===true){canvas.width=width;canvas.height=height;}else{ctx.clearRect(0,0,width_source,height_source);}
ctx.putImageData(img2,0,0);},base64ToBlob:function(base64,mime){mime=mime||'';var sliceSize=1024;var byteChars=window.atob(base64);var byteArrays=[];for(var offset=0,len=byteChars.length;offset<len;offset+=sliceSize){var slice=byteChars.slice(offset,offset+sliceSize);var byteNumbers=new Array(slice.length);for(var i=0;i<slice.length;i++){byteNumbers[i]=slice.charCodeAt(i);}
var byteArray=new Uint8Array(byteNumbers);byteArrays.push(byteArray);}
return new Blob(byteArrays,{type:mime});},getPixel:function(){var pixel=bluewave.utils.pixel;if(!pixel){var canvas=document.createElement('canvas');canvas.width=1;canvas.height=1;pixel=canvas.toDataURL('image/png');bluewave.utils.pixel=pixel;}
return pixel;},parseData:function(data,config){var records=[];if(data==null||data.length==0)return records;if(!javaxt.dhtml.utils.isArray(data[0])){var sheet;var sheetName=config.sheetName;if(sheetName){for(var i=0;i<data.length;i++){if(data[i].name===sheetName){sheet=data[i];break;}}}
else{if(data[0].name&&data[0].getData){sheet=data[0];}}
if(!sheet)return records;data=sheet.getData();if(data==null||data.length==0)return records;}
var keys=[];var offset=0;if(config.hasHeader===true){keys=data[0];offset=1;}
else{data[0].forEach((d,i)=>{keys.push((i+1)+"");});}
for(var i=offset;i<data.length;i++){var record={};data[i].forEach((d,j)=>{var key=keys[j];var val=d;record[key]=val;});records.push(record);}
return records;},parseCSV:function(text,options){if(!options)options={};var defaultConfig={headers:false,quote:"\"",separator:","};javaxt.dhtml.utils.merge(options,defaultConfig);options.headers=false;return alasql.from.CSV(text,options,null,0,null);},parseXLS:function(data,options){if(!options)options={};var XLSX=alasql.utils.global.XLSX;var dataType='binary';if(data instanceof ArrayBuffer){dataType='base64';var o='',l=0,w=10240;for(;l<data.byteLength/w;++l)
o+=String.fromCharCode.apply(null,new Uint8Array(data.slice(l*w,l*w+w)));o+=String.fromCharCode.apply(null,new Uint8Array(data.slice(l*w)));data=btoa(o);}
var workbook=XLSX.read(data,{type:dataType,...alasql.options.excel,...options});var sheetNames=workbook.SheetNames;if(!sheetNames)sheetNames=[];var sheets=[];sheetNames.forEach((name,i)=>{sheets.push({name:name,getData:function(options){if(!options)options={};var defaultConfig={headers:false};javaxt.dhtml.utils.merge(options,defaultConfig);options.headers=false;return bluewave.utils.parseWorkbook(this.name,workbook,options);}});});return sheets;},parseWorkbook:function(sheetid,workbook,opt){if(!opt)opt={};function getHeaderText(text){if(text&&alasql.options.casesensitive===false){return text.toLowerCase();}else{return text;}}
var range;var res=[];if(typeof opt.range==='undefined'){range=workbook.Sheets[sheetid]['!ref'];}else{range=opt.range;if(workbook.Sheets[sheetid][range]){range=workbook.Sheets[sheetid][range];}}
if(range){var rg=range.split(':');var col0=rg[0].match(/[A-Z]+/)[0];var row0=+rg[0].match(/[0-9]+/)[0];var col1=rg[1].match(/[A-Z]+/)[0];var row1=+rg[1].match(/[0-9]+/)[0];var hh={};var xlscnCol0=alasql.utils.xlscn(col0);var xlscnCol1=alasql.utils.xlscn(col1);for(var j=xlscnCol0;j<=xlscnCol1;j++){var col=alasql.utils.xlsnc(j);if(opt.headers){if(workbook.Sheets[sheetid][col+''+row0]){hh[col]=getHeaderText(workbook.Sheets[sheetid][col+''+row0].v);}else{hh[col]=getHeaderText(col);}}else{hh[col]=col;}}
if(opt.headers){row0++;}
for(var i=row0;i<=row1;i++){var row;if(opt.headers){row={};}
else{row=[];}
for(var j=xlscnCol0;j<=xlscnCol1;j++){var col=alasql.utils.xlsnc(j);var val=null;if(workbook.Sheets[sheetid][col+''+i]){val=workbook.Sheets[sheetid][col+''+i].v;}
if(opt.headers){if(val)row[hh[col]]=val;}
else{row.push(val);}}
res.push(row);}}else{res.push([]);}
if(res.length>0&&res[res.length-1]&&Object.keys(res[res.length-1]).length==0){res.pop();}
return res;}};bluewave.utils.Confirm=null;var confirm=function(msg,config){if(!(typeof(msg)==='string'||msg instanceof String)){config=msg;}
javaxt.dhtml.utils.merge(config,{title:"Confirm",text:msg});var win=bluewave.utils.Confirm;if(!win){var body=document.getElementsByTagName("body")[0];var buttonDiv=document.createElement("div");buttonDiv.className="button-div";var createButton=function(label,result){var input=document.createElement("input");input.type="button";input.className="form-button";input.onclick=function(){win.result=this.result;win.close();};input.setLabel=function(label){if(label)this.name=this.value=label;};input.setValue=function(b){if(b===true||b===false)this.result=b;};input.update=function(config){if(config){this.setLabel(config.label);this.setValue(config.value);}};input.setLabel(label);input.setValue(result);buttonDiv.appendChild(input);return input;};win=bluewave.utils.Confirm=new javaxt.dhtml.Window(body,{width:450,height:150,valign:"top",modal:true,footer:buttonDiv,style:{panel:"window",header:"window-header",title:"window-title",buttonBar:"window-header-button-bar",button:"window-header-button",body:"window-body confirm-body"}});win.leftButton=createButton("OK",true);win.rightButton=createButton("Cancel",false);}
win.setTitle(config.title);win.setContent(config.text.replace("\n","<p></p>"));win.leftButton.update(config.leftButton);win.rightButton.update(config.rightButton);win.result=false;win.onClose=function(){var callback=config.callback;if(callback)callback.apply(win,[win.result]);};win.show();return false;};bluewave.utils.Alert=null;var alert=function(msg){if(msg==null)msg="";if(!(typeof(msg)==='string'||msg instanceof String)){if(typeof msg.responseText!=='undefined'){msg=(msg.responseText.length>0?msg.responseText:msg.statusText);if(!msg)msg="Unknown Server Error";}}
var win=bluewave.utils.Alert;if(!win){var body=document.getElementsByTagName("body")[0];var outerDiv=document.createElement('div');outerDiv.style.width="100%";outerDiv.style.height="100%";outerDiv.style.position="relative";outerDiv.style.cursor="inherit";var innerDiv=document.createElement('div');innerDiv.style.width="100%";innerDiv.style.height="100%";innerDiv.style.position="absolute";innerDiv.style.overflowX='hidden';innerDiv.style.cursor="inherit";outerDiv.appendChild(innerDiv);win=bluewave.utils.Alert=new javaxt.dhtml.Window(body,{width:450,height:200,valign:"top",modal:true,title:"Alert",body:outerDiv,style:{panel:"window",header:"window-header alert-header",title:"window-title",buttonBar:"window-header-button-bar",button:"window-header-button",body:"window-body alert-body"}});win.div=innerDiv;}
win.div.innerHTML=msg;win.show();};
if(!bluewave)var bluewave={};if(!bluewave.editor)bluewave.editor={};bluewave.editor.BarEditor=function(parent,config){var me=this;var defaultConfig={panel:{},chart:{showTooltip:true}};var panel;var inputData=[];var previewArea;var barChart;var optionsDiv;var plotInputs={};var chartConfig={};var colorPicker;var init=function(){if(!config)config={};config=merge(config,defaultConfig);chartConfig=config.chart;let table=createTable();let tbody=table.firstChild;var tr=document.createElement("tr");tbody.appendChild(tr);parent.appendChild(table);me.el=table;var td;td=document.createElement("td");td.style.height="100%";tr.appendChild(td);var outerDiv=document.createElement("div");outerDiv.className="chart-editor-options";outerDiv.style.height="100%";outerDiv.style.position="relative";outerDiv.style.overflow="hidden";outerDiv.style.overflowY="auto";td.appendChild(outerDiv);optionsDiv=document.createElement("div");optionsDiv.style.position="absolute";outerDiv.appendChild(optionsDiv);td=document.createElement("td");td.className="chart-editor-preview";td.style.width="100%";td.style.height="100%";tr.appendChild(td);var outerDiv=document.createElement("div");outerDiv.style.height="100%";outerDiv.style.position="relative";outerDiv.style.overflow="hidden";td.appendChild(outerDiv);panel=createDashboardItem(outerDiv,{width:"100%",height:"100%",title:"Untitled",settings:true});previewArea=panel.innerDiv;panel.el.className="";panel.el.style.position="absolute";addTextEditor(panel.title,function(title){panel.title.innerHTML=title;chartConfig.chartTitle=title;});panel.settings.onclick=function(){editChart();};barChart=new bluewave.charts.BarChart(previewArea,{});barChart.onClick=function(bar,barID){editBar(barID);};};this.update=function(node){me.clear();var clone={};merge(clone,node.config);merge(clone,config.chart);chartConfig=clone;for(var key in node.inputs){if(node.inputs.hasOwnProperty(key)){var inputNode=node.inputs[key];var data=parseData(inputNode.data,inputNode.config);if(data.length>0)inputData.push(data);}}
if(chartConfig.chartTitle){panel.title.innerHTML=chartConfig.chartTitle;}
createForm(optionsDiv);createOptions();};this.clear=function(){inputData=[];chartConfig={};plotInputs={};panel.title.innerHTML="Untitled";optionsDiv.innerHTML="";if(barChart)barChart.clear();if(colorPicker)colorPicker.hide();};this.getConfig=function(){let copy=Object.assign({},chartConfig);return copy;};this.getChart=function(){return previewArea;};this.renderChart=function(parent){var chart=new bluewave.charts.BarChart(parent,{});chart.update(chartConfig,inputData);return chart;};var createOptions=function(){for(let i=0;i<inputData.length;i++){var n=i>0?(i+1):"";let xAxisN=`xAxis${n}`;let yAxisN=`yAxis${n}`;let groupN=`group${n}`;plotInputs[groupN].add("","");let dataOptions=Object.keys(inputData[i][0]);dataOptions.forEach((val)=>{plotInputs[xAxisN].add(val,val);plotInputs[yAxisN].add(val,val);plotInputs[groupN].add(val,val);});plotInputs[xAxisN].setValue(chartConfig[xAxisN],true);plotInputs[yAxisN].setValue(chartConfig[yAxisN],true);if(chartConfig[groupN]){plotInputs[groupN].setValue(chartConfig[groupN],true);}}
createBarPreview();};var createForm=function(parent){var items=[];for(var i=0;i<inputData.length;i++){var n=i>0?(i+1):"";items.push({group:"Series "+(i>0?n:1),items:[createLabel("X-Axis"),createDropdown(`xAxis${n}`,plotInputs),createLabel("Y-Axis"),createDropdown(`yAxis${n}`,plotInputs),createLabel("Separate By"),createDropdown(`group${n}`,plotInputs)]});}
var div=document.createElement("div");div.style.height="100%";div.style.zIndex=1;parent.appendChild(div);var form=new javaxt.dhtml.Form(div,{style:config.style.form,items:items});form.onChange=function(input,value){var key=input.name;chartConfig[key]=value;createBarPreview();};};var createLabel=function(label){var row=document.createElement("div");row.className="form-label";row.innerText=label+":";return{name:"",label:"",type:{getValue:function(){},setValue:function(){},el:row}};};var createDropdown=function(inputType,input){input[inputType]=new javaxt.dhtml.ComboBox(document.createElement("div"),{style:config.style.combobox,readOnly:true});return{name:inputType,label:"",type:input[inputType]};};var createBarPreview=function(){onRender(previewArea,function(){barChart.update(chartConfig,inputData);});};var editChart=function(){var styleEditor=getStyleEditor(config);var body=styleEditor.getBody();body.innerHTML="";var chartLayout=new javaxt.dhtml.ComboBox(document.createElement("div"),{style:config.style.combobox,readOnly:true});chartLayout.add("Vertical","vertical");chartLayout.add("Horizontal","horizontal");chartLayout.setValue("vertical");var form=new javaxt.dhtml.Form(body,{style:config.style.form,items:[{group:"General",items:[{name:"layout",label:"Chart Layout",type:chartLayout},{name:"stackValues",label:"Stack Bars",type:"checkbox",options:[{label:"",value:true,checked:false}]}]},{group:"X-Axis",items:[{name:"xLabel",label:"Show Labels",type:"checkbox",options:[{label:"",value:true}]},{name:"xGrid",label:"Show Grid Lines",type:"checkbox",options:[{label:"",value:true}]}]},{group:"Y-Axis",items:[{name:"yLabel",label:"Show Labels",type:"checkbox",options:[{label:"",value:true}]},{name:"yGrid",label:"Show Grid Lines",type:"checkbox",options:[{label:"",value:true}]}]}]});var layoutField=form.findField("layout");var layout=chartConfig.layout;layoutField.setValue(layout==="horizontal"?"horizontal":"vertical");var xGridField=form.findField("xGrid");var xGrid=chartConfig.xGrid;xGridField.setValue(xGrid===true?true:false);var yGridField=form.findField("yGrid");var yGrid=chartConfig.yGrid;yGridField.setValue(yGrid===true?true:false);var xLabelField=form.findField("xLabel");var xLabel=chartConfig.xLabel;xLabelField.setValue(xLabel===true?true:false);var yLabelField=form.findField("yLabel");var yLabel=chartConfig.yLabel;yLabelField.setValue(yLabel===true?true:false);var stackField=form.findField("stackValues");var stack=chartConfig.stackValues;stackField.setValue(stack===true?true:false);form.onChange=function(){var settings=form.getData();if(settings.xGrid==="true")settings.xGrid=true;else settings.xGrid=false;if(settings.yGrid==="true")settings.yGrid=true;else settings.yGrid=false;if(settings.xLabel==="true")settings.xLabel=true;else settings.xLabel=false;if(settings.yLabel==="true")settings.yLabel=true;else settings.yLabel=false;if(settings.stackValues==="true")settings.stackValues=true;else settings.stackValues=false;chartConfig.layout=settings.layout;chartConfig.xGrid=settings.xGrid;chartConfig.yGrid=settings.yGrid;chartConfig.xLabel=settings.xLabel;chartConfig.yLabel=settings.yLabel;chartConfig.stackValues=settings.stackValues;var animationSteps=chartConfig.animationSteps;chartConfig.animationSteps=0;createBarPreview();chartConfig.animationSteps=animationSteps;};styleEditor.showAt(108,57);form.resize();};var editBar=function(datasetID){var styleEditor=getStyleEditor(config);var body=styleEditor.getBody();body.innerHTML="";var form=new javaxt.dhtml.Form(body,{style:config.style.form,items:[{group:"Fill Style",items:[{name:"barColor",label:"Color",type:new javaxt.dhtml.ComboBox(document.createElement("div"),{style:config.style.combobox})},{name:"fillOpacity",label:"Opacity",type:"text"}]}]});createColorOptions("barColor",form);createSlider("fillOpacity",form,"%");var fillOpacity=chartConfig.fillOpacity;if(isNaN(fillOpacity))fillOpacity=1;chartConfig.fillOpacity=fillOpacity;form.findField("fillOpacity").setValue(fillOpacity*100);if(datasetID!==null&&datasetID!==undefined){let n=`${datasetID}`;if(!chartConfig["barColor"+n])chartConfig["barColor"+n]="#6699CC";if(isNaN(chartConfig["fillOpacity"+n]))chartConfig["fillOpacity"+n]=1;form.findField("barColor").setValue(chartConfig["barColor"+n]);form.findField("fillOpacity").setValue(chartConfig["fillOpacity"+n]*100);form.onChange=function(){let settings=form.getData();chartConfig["barColor"+n]=settings.barColor;chartConfig["fillOpacity"+n]=settings.fillOpacity;createBarPreview();};}
styleEditor.showAt(108,57);form.resize();};var createColorOptions=function(inputName,form){bluewave.utils.createColorOptions(inputName,form,function(colorField){if(!colorPicker)colorPicker=bluewave.utils.createColorPickerCallout(config);var rect=javaxt.dhtml.utils.getRect(colorField.row);var x=rect.x+rect.width+15;var y=rect.y+(rect.height/2);colorPicker.showAt(x,y,"right","middle");colorPicker.setColor(colorField.getValue());colorPicker.onChange=function(color){colorField.setValue(color);};});};var merge=javaxt.dhtml.utils.merge;var onRender=javaxt.dhtml.utils.onRender;var createTable=javaxt.dhtml.utils.createTable;var createDashboardItem=bluewave.utils.createDashboardItem;var createSlider=bluewave.utils.createSlider;var addTextEditor=bluewave.utils.addTextEditor;var getStyleEditor=bluewave.utils.getStyleEditor;var getType=bluewave.chart.utils.getType;var parseData=bluewave.utils.parseData;init();};
if(!bluewave)var bluewave={};if(!bluewave.editor)bluewave.editor={};bluewave.editor.CalendarEditor=function(parent,config){var me=this;var defaultConfig={panel:{},colors:{green:["#fff","#ebf5dc","#cbe9a5","#2a671a"],blue:["#fff","#aebfee","#587bdd","#1d3c90"],orange:["#fff","#fbdc77","#f8c82c","#b78e06"]},chart:{cellSize:13,showTooltip:true}};var panel;var inputData=[];var previewArea;var calendarChart;var optionsDiv;var calendarInputs={};var chartConfig={};var styleEditor;var init=function(){if(!config)config={};defaultConfig.chart.colors=defaultConfig.colors.blue;config=merge(config,defaultConfig);chartConfig=config.chart;var table=createTable(parent);var tr=table.addRow();var td;me.el=table;td=tr.addColumn();let div=document.createElement("div");div.className="chart-editor-options";td.appendChild(div);optionsDiv=div;td=tr.addColumn();td.className="chart-editor-preview";td.style.width="100%";td.style.height="100%";panel=createDashboardItem(td,{width:"100%",height:"100%",title:"Untitled",settings:true});previewArea=panel.innerDiv;calendarChart=new bluewave.charts.CalendarChart(previewArea,{});panel.el.className="";addTextEditor(panel.title,function(title){panel.title.innerHTML=title;chartConfig.chartTitle=title;});panel.settings.onclick=function(){if(chartConfig)editStyle();};};this.update=function(node){me.clear();var clone={};merge(clone,node.config);merge(clone,config.chart);chartConfig=clone;for(var key in node.inputs){if(node.inputs.hasOwnProperty(key)){var inputNode=node.inputs[key];var data=parseData(inputNode.data,inputNode.config);if(data.length>0)inputData.push(data);}}
if(chartConfig.chartTitle){panel.title.innerHTML=chartConfig.chartTitle;}
createOptions(optionsDiv);createPreview();};this.clear=function(){inputData=[];chartConfig={};panel.title.innerHTML="Untitled";optionsDiv.innerHTML="";if(calendarChart)calendarChart.clear();};this.getConfig=function(){return chartConfig;};this.getChart=function(){return previewArea;};this.renderChart=function(parent){var chart=new bluewave.charts.CalendarChart(parent,{});chart.update(chartConfig,inputData[0]);return chart;};var createOptions=function(parent){var data=inputData[0];var fields=Object.keys(data[0]);var dateFields=[];var valueFields=[];fields.forEach((field)=>{var values=[];data.forEach((d)=>{var val=d[field];values.push(val);});var type=getType(values);if(type=="date")dateFields.push(field);if(type=="number"||type=="currency")valueFields.push(field);});var table=createTable();var tbody=table.firstChild;table.style.height="";parent.appendChild(table);createDropdown(tbody,"Date","date");createDropdown(tbody,"Value","value");dateFields.forEach((field)=>{calendarInputs.date.add(field,field);});valueFields.forEach((field)=>{calendarInputs.value.add(field,field);});if(chartConfig.date){calendarInputs.date.setValue(chartConfig.date,false);}
else{calendarInputs.date.setValue(dateFields[0],false);}
if(chartConfig.value){calendarInputs.value.setValue(chartConfig.value,false);}
else{calendarInputs.value.setValue(valueFields[0],false);}};var createDropdown=function(tbody,displayName,inputType){var tr,td;tr=document.createElement("tr");tbody.appendChild(tr);td=document.createElement("td");tr.appendChild(td);td.innerHTML=displayName+":";tr=document.createElement("tr");tbody.appendChild(tr);td=document.createElement("td");tr.appendChild(td);calendarInputs[inputType]=new javaxt.dhtml.ComboBox(td,{style:config.style.combobox,readOnly:true});calendarInputs[inputType].clear();calendarInputs[inputType].onChange=function(name,value){chartConfig[inputType]=value;createPreview();};};var createPreview=function(){if(chartConfig.date&&chartConfig.value){var data=inputData[0];calendarChart.update(chartConfig,data);}};var editStyle=function(){if(!styleEditor){styleEditor=new javaxt.dhtml.Window(document.body,{title:"Edit Style",width:400,valign:"top",modal:false,resizable:false,style:config.style.window});}
var body=styleEditor.getBody();body.innerHTML="";var colorField=new javaxt.dhtml.ComboBox(document.createElement("div"),{style:config.style.combobox});var form=new javaxt.dhtml.Form(body,{style:config.style.form,items:[{group:"General",items:[{name:"color",label:"Color",type:colorField}]},{group:"Labels",items:[{name:"dayLabel",label:"Show Day",type:"checkbox",options:[{label:"",value:true}]},{name:"yearLabel",label:"Show Year",type:"checkbox",options:[{label:"",value:true}]}]},{group:"Graph",items:[{name:"cellSize",label:"Cell Size",type:"text"}]}]});for(var key in config.colors){if(config.colors.hasOwnProperty(key)){colorField.add(key,JSON.stringify(config.colors[key]));}}
if(chartConfig.colors){var color=chartConfig.colors;colorField.getOptions().every(function(d){var key=d.text;var val=d.value;if(color==key||JSON.stringify(color)==val){colorField.setValue(key);return false;}
return true;});}
else{colorField.setValue("blue");}
var dayLabelField=form.findField("dayLabel");var dayLabel=chartConfig.dayLabel;dayLabelField.setValue(dayLabel===true?true:false);var yearLabelField=form.findField("yearLabel");var yearLabel=chartConfig.yearLabel;yearLabelField.setValue(yearLabel===true?true:false);var cellSizeField=form.findField("cellSize");var cellSizeValue=chartConfig.cellSize;if(isNaN(cellSizeValue)||cellSizeValue<1)cellSizeValue=13;cellSizeField.setValue(cellSizeValue);form.onChange=function(){var settings=form.getData();if(settings.dayLabel==="true")settings.dayLabel=true;else settings.dayLabel=false;if(settings.yearLabel==="true")settings.yearLabel=true;else settings.yearLabel=false;chartConfig.dayLabel=settings.dayLabel;chartConfig.yearLabel=settings.yearLabel;var cellSize=settings.cellSize;if(isNaN(cellSize)||cellSize<1)cellSize=13;chartConfig.cellSize=cellSize;chartConfig.colors=JSON.parse(settings.color);createPreview();};styleEditor.showAt(108,57);form.resize();};var merge=javaxt.dhtml.utils.merge;var onRender=javaxt.dhtml.utils.onRender;var createTable=javaxt.dhtml.utils.createTable;var createDashboardItem=bluewave.utils.createDashboardItem;var createSlider=bluewave.utils.createSlider;var addTextEditor=bluewave.utils.addTextEditor;var getType=bluewave.chart.utils.getType;var parseData=bluewave.utils.parseData;init();};
if(!bluewave)var bluewave={};if(!bluewave.editor)bluewave.editor={};bluewave.editor.CsvEditor=function(parent,config){var me=this;var defaultConfig={panel:{},data:{hasHeader:false,sheetName:null}};var combobox,toggleSwitch;var gridContainer,grid;var data=[];var init=function(){if(!config)config={};config=merge(config,defaultConfig);var table=createTable(parent);createToolbar(table.addRow().addColumn());gridContainer=table.addRow().addColumn();gridContainer.style.height="100%";gridContainer.className="grid-container-"+new Date().getTime();createFooter(table.addRow().addColumn());me.el=table;};this.clear=function(){data=[];grid=null;gridContainer.innerHTML="";combobox.clear();combobox.hide();toggleSwitch.setValue(false);};this.update=function(node){me.clear();var clone={};merge(clone,node.config);merge(clone,defaultConfig.data);config.data=clone;var silent=true;if(config.data.hasHeader){toggleSwitch.setValue(true,silent);}
if(!isArray(data[0])){for(var i=0;i<data.length;i++){var sheetName=data[i].name;combobox.add(sheetName,sheetName);}}
if(config.data.sheetName){combobox.setValue(config.data.sheetName,silent);}
if(!node.data&&node.file){var file=node.file;var fileName=file.name.toLowerCase();var idx=fileName.lastIndexOf(".");if(idx>-1){var ext=fileName.substring(idx+1);if(ext==='csv'||ext==='tab'||ext==='tsv'){var reader=new FileReader();reader.onload=(function(f){return function(e){var text=e.target.result;data=parseCSV(text,{separator:ext==='csv'?",":"\t"});node.data=data;updateGrid();};})(file);reader.readAsText(file);}
else if(ext==='xls'||ext==='xlsx'){var reader=new FileReader();reader.onload=(function(f){return function(e){var arrayBuffer=e.target.result;data=parseXLS(arrayBuffer);node.data=data;data.forEach((sheet)=>{combobox.add(sheet.name,sheet.name);});combobox.show();};})(file);reader.readAsArrayBuffer(file);}
else{}}}
else{data=node.data;updateGrid();}};this.getConfig=function(){return config.data;};var createToolbar=function(parent){var div=document.createElement("div");div.className="panel-toolbar";parent.appendChild(div);var row=createTable(div).addRow();var td;td=row.addColumn();td.style.width="100%";combobox=new javaxt.dhtml.ComboBox(td,{style:config.style.combobox,readOnly:true});combobox.onChange=function(val){config.data.hasHeader=false;config.data.sheetName=val;updateGrid();};td=row.addColumn();var div=document.createElement("div");div.style.width="135px";td.appendChild(div);var textString=document.createElement("div");textString.innerText="Has Header";textString.className="toolbar-button-label";textString.style.float="left";textString.style.padding="0 5px 0 8px";textString.style.lineHeight="24px";div.appendChild(textString);var toggleContainer=document.createElement("div");toggleContainer.style.float="left";div.appendChild(toggleContainer);toggleSwitch=new javaxt.dhtml.Switch(toggleContainer);toggleSwitch.setValue(false);toggleSwitch.onChange=function(){config.data.hasHeader=toggleSwitch.getValue();updateGrid();};};var createFooter=function(parent){var div=document.createElement("div");div.style.float="right";div.style.width="175px";div.style.padding="0px 16px 8px 0px";parent.appendChild(div);var slider=document.createElement("input");div.appendChild(slider);slider.type="range";slider.className="dashboard-slider";var min=8;var max=14;slider.setAttribute("min",min+1);slider.setAttribute("max",max+1);slider.onchange=function(){var val=(this.value-1);updateGridSize(val);};};var updateGrid=function(){grid=null;gridContainer.innerHTML="";if(!data)return;if(data.length===0)return;var hasHeader=config.data.hasHeader;if(!isArray(data[0])){var sheetName=config.data.sheetName;if(sheetName){for(var i=0;i<data.length;i++){if(data[i].name===sheetName){var sheet=data[i];grid=createGrid(sheet.getData(),hasHeader,gridContainer,config);break;}}}}
else{grid=createGrid(data,hasHeader,gridContainer,config);}};var updateGridSize=function(size){var gridClass="."+gridContainer.className;var targetStyle;var styles=document.getElementsByTagName("style");for(var i=0;i<styles.length;i++){var sheet=styles[i].sheet;var rules=sheet.cssRules;for(var j=0;j<rules.length;j++){var rule=rules[j];if(rule.selectorText){if(rule.selectorText.indexOf(gridClass===0)){sheet.deleteRule(j);targetStyle=styles[i];break;}}}}
if(!targetStyle){targetStyle=document.createElement("style");targetStyle.appendChild(document.createTextNode(""));document.head.appendChild(targetStyle);}
targetStyle.sheet.insertRule(gridClass+" .table-header-col, "+
gridClass+" .table-col {"+"height: "+(size*2.5)+"px;"+"line-height: "+(size*2.5)+"px;"+"font-size: "+size+"px;"+"}",0);};var merge=javaxt.dhtml.utils.merge;var isArray=javaxt.dhtml.utils.isArray;var createTable=javaxt.dhtml.utils.createTable;var createGrid=bluewave.utils.createGrid;var parseCSV=bluewave.utils.parseCSV;var parseXLS=bluewave.utils.parseXLS;init();};
if(!bluewave)var bluewave={};if(!bluewave.editor)bluewave.editor={};bluewave.editor.FilterEditor=function(parent,config){var me=this;var defaultConfig={supportedLanguages:["sql","javascript"],style:{border:"1px solid #b5b5b5",editor:{height:"240px",},bottomPanel:{backgroundColor:"#e4e4e4",borderTop:"1px solid #b5b5b5"}},filter:{mode:"sql",code:""}};var editor;var combobox;var waitmask;var gridContainer,grid;var inputData=[];var data=[];var button={};var getRecords;var init=function(){if(!config)config={};config=merge(config,defaultConfig);var table=createTable(parent);var td;createToolbar(table.addRow().addColumn());var td=table.addRow().addColumn();setStyle(td,config.style.editor);td.style.borderBottom=config.style.border;createEditor(td);var target=td;var td=table.addRow().addColumn();setStyle(td,config.style.bottomPanel);td.style.height="100%";td.style.verticalAlign="top";addVerticalResizer(td,target);createGridContainer(td);createWaitMask(td);me.el=table;};this.getConfig=function(){return config.filter;};this.getData=function(){return data;};this.clear=function(){inputData=[];data=[];grid=null;gridContainer.innerHTML="";};this.update=function(node,callback){me.clear();config.filter=merge(node.config,defaultConfig.filter);for(var key in node.inputs){if(node.inputs.hasOwnProperty(key)){var inputNode=node.inputs[key];var data=parseData(inputNode.data,inputNode.config);if(data.length>0)inputData.push({raw:inputNode.data,data:data,config:inputNode.config});}}
combobox.setValue(config.filter.mode,true);editor.setMode(config.filter.mode);var code=config.filter.code;var defaultCode=getDefaultCode(combobox.getValue());if(code){code=code+"";if(code.trim().length==0){code=defaultCode;}}
else{code=defaultCode;}
editor.setValue(code);runScript(callback);};var createToolbar=function(parent){var div=document.createElement("div");div.className="panel-toolbar";parent.appendChild(div);var table=createTable(div);table.style.width="";var row=table.addRow();var td;td=row.addColumn();button.run=createButton(td,{style:config.style.toolbarButton,icon:"fas fa-play",label:"Run"});button.run.onClick=runScript;td=row.addColumn();td.style.verticalAlign="bottom";createSpacer(td);td=row.addColumn();td.innerText="Mode:";td=row.addColumn();td.style.width="150px";td.style.paddingLeft="5px";combobox=new javaxt.dhtml.ComboBox(td,{style:config.style.combobox,readOnly:true});config.supportedLanguages.forEach((lang)=>{var label;if(lang==="sql")label=lang.toUpperCase();else label=lang.substring(0,1).toUpperCase()+lang.substring(1);combobox.add(label,lang);});combobox.onChange=function(label,value,prevLabel,prevValue){var code=editor.getValue();var defaultCode=getDefaultCode(prevValue);if(code===defaultCode){editor.setMode(value);editor.setValue(getDefaultCode(value));}
else{confirm("Are you sure you want to delete this code and switch editor?",{leftButton:{label:"Yes",value:true},rightButton:{label:"No",value:false},callback:function(yes){if(yes){editor.setMode(value);editor.setValue(getDefaultCode(value));gridContainer.innerHTML="";}
else{combobox.setValue(prevValue,true);}}});}};};var createEditor=function(parent){if(typeof CodeMirror!=='undefined'){var outerDiv=document.createElement("div");outerDiv.style.height="100%";outerDiv.style.position="relative";parent.appendChild(outerDiv);var innerDiv=document.createElement("div");innerDiv.style.width="100%";innerDiv.style.height="100%";innerDiv.style.position="absolute";innerDiv.style.overflow="auto";outerDiv.appendChild(innerDiv);var createCodeMirror=function(){editor=CodeMirror(innerDiv,{value:"",mode:config.filter.mode,lineNumbers:false,indentUnit:4});editor.setValue=function(str){var doc=this.getDoc();doc.setValue(str);doc.clearHistory();var cm=this;setTimeout(function(){cm.refresh();},200);};editor.getValue=function(){return this.getDoc().getValue();};editor.setMode=function(mode){if(mode===editor.getOption("mode"))return;config.filter.mode=mode;var val=editor.getValue();editor=null;innerDiv.innerHTML="";createCodeMirror();editor.setValue(val);};};createCodeMirror();}
else{editor=document.createElement('textarea');editor.style.height="100%";editor.style.width="100%";editor.style.resize="none";parent.appendChild(editor);editor.getValue=function(){return this.value;};editor.setValue=function(str){this.value=str;};editor.setMode=function(){};}};var createGridContainer=function(parent){gridContainer=document.createElement("div");gridContainer.className="grid-container-"+new Date().getTime();gridContainer.style.height="100%";parent.appendChild(gridContainer);};var addVerticalResizer=function(parent,target){var div=document.createElement("div");div.style.position="relative";var resizeHandle=document.createElement("div");resizeHandle.style.position="absolute";resizeHandle.style.width="100%";resizeHandle.style.height="10px";resizeHandle.style.top="-5px";resizeHandle.style.cursor="ns-resize";resizeHandle.style.zIndex=2;div.appendChild(resizeHandle);parent.appendChild(div);javaxt.dhtml.utils.initDrag(resizeHandle,{onDragStart:function(x,y){var div=this;div.yOffset=y;div.initialHeight=target.offsetHeight;},onDrag:function(x,y){var div=this;var top=(div.yOffset-y);var height=div.initialHeight-top;target.style.height=height+"px";},onDragEnd:function(){}});};var createWaitMask=function(parent){if(javaxt.express){waitmask=new javaxt.express.WaitMask(parent);}
else{waitmask={show:function(){},hide:function(){}};}};var getDefaultCode=function(mode){if(mode=="sql"){return"select * from ?";}
if(mode=="javascript"){return""+"var records = [];\n"+"data.forEach((record, i)=>{\n"+"    \n"+"    //TODO: do something with the record\n"+"    \n"+"    records.push(record);\n"+"});\n"+"return records;";}};var runScript=function(callback){gridContainer.innerHTML="";var mode=combobox.getValue();var code=editor.getValue();var input=inputData[0];waitmask.show();setTimeout(()=>{var arr;if(mode==="sql"){arr=alasql(code,[input.data]);}
else if(mode==="javascript"){getRecords=null;var fn="getRecords = function(data){\n"+code+"\n}";eval(fn);arr=getRecords(input.data);}
waitmask.hide();if(arr){data=[];if(arr.length>0){var keys=Object.keys(arr[0]);data.push(keys);arr.forEach((d)=>{var record=[];keys.forEach((key)=>{record.push(d[key]);});data.push(record);});createGrid(data,true,gridContainer,config);}}
config.filter.code=code;config.filter.hasHeader=input.config.hasHeader;config.filter.sheetName=input.config.sheetName;if(callback)callback.apply(me,[data,config.filter]);},300);};var merge=javaxt.dhtml.utils.merge;var setStyle=javaxt.dhtml.utils.setStyle;var createTable=javaxt.dhtml.utils.createTable;var createButton=bluewave.utils.createButton;var createSpacer=bluewave.utils.createSpacer;var createGrid=bluewave.utils.createGrid;var parseData=bluewave.utils.parseData;init();};
if(!bluewave)var bluewave={};if(!bluewave.editor)bluewave.editor={};bluewave.editor.HistogramEditor=function(parent,config){var me=this;var defaultConfig={panel:{},chart:{}};var panel;var inputData=[];var svg;var previewArea;var barChart;var optionsDiv;var plotInputs={};var chartConfig={};var colorPicker;var init=function(){if(!config)config={};config=merge(config,defaultConfig);chartConfig=config.chart;let table=createTable();let tbody=table.firstChild;var tr=document.createElement("tr");tbody.appendChild(tr);parent.appendChild(table);me.el=table;var td;td=document.createElement("td");td.style.height="100%";tr.appendChild(td);var outerDiv=document.createElement("div");outerDiv.className="chart-editor-options";outerDiv.style.height="100%";outerDiv.style.position="relative";outerDiv.style.overflow="hidden";outerDiv.style.overflowY="auto";td.appendChild(outerDiv);optionsDiv=document.createElement("div");optionsDiv.style.position="absolute";outerDiv.appendChild(optionsDiv);td=document.createElement("td");td.className="chart-editor-preview";td.style.width="100%";td.style.height="100%";tr.appendChild(td);var outerDiv=document.createElement("div");outerDiv.style.height="100%";outerDiv.style.position="relative";outerDiv.style.overflow="hidden";td.appendChild(outerDiv);panel=createDashboardItem(outerDiv,{width:"100%",height:"100%",title:"Untitled",settings:true});previewArea=panel.innerDiv;panel.el.className="";panel.el.style.position="absolute";addTextEditor(panel.title,function(title){panel.title.innerHTML=title;chartConfig.chartTitle=title;});panel.settings.onclick=function(){editChart();};barChart=new bluewave.charts.BarChart(previewArea,{});barChart.onClick=function(bar,barID){editBar(barID);};};this.update=function(node){me.clear();var clone={};merge(clone,node.config);merge(clone,config.chart);chartConfig=clone;chartConfig.barType="histogram";for(var key in node.inputs){if(node.inputs.hasOwnProperty(key)){var inputNode=node.inputs[key];var data=parseData(inputNode.data,inputNode.config);if(data.length>0)inputData.push(data);}}
if(chartConfig.chartTitle){panel.title.innerHTML=chartConfig.chartTitle;}
createForm(optionsDiv);createOptions();};this.clear=function(){inputData=[];chartConfig={};plotInputs={};panel.title.innerHTML="Untitled";optionsDiv.innerHTML="";if(barChart)barChart.clear();if(colorPicker)colorPicker.hide();};this.getConfig=function(){let copy=Object.assign({},chartConfig);return copy;};this.getChart=function(){return previewArea;};this.renderChart=function(parent){var chart=new bluewave.charts.BarChart(parent,{});chart.update(chartConfig,inputData);return chart;};var createOptions=function(){for(let i=0;i<inputData.length;i++){var n=i>0?(i+1):"";let xAxisN=`values${n}`;let groupN=`group${n}`;plotInputs[groupN].add("","");let dataOptions=Object.keys(inputData[i][0]);dataOptions.forEach((val)=>{plotInputs[xAxisN].add(val,val);plotInputs[groupN].add(val,val);});plotInputs[xAxisN].setValue(chartConfig[xAxisN],true);if(chartConfig[groupN]){plotInputs[groupN].setValue(chartConfig[groupN],true);}}
createBarPreview();};var createForm=function(parent){var items=[];for(var i=0;i<inputData.length;i++){var n=i>0?(i+1):"";items.push({group:"Series "+(i>0?n:1),items:[createLabel("Values"),createDropdown(`values${n}`,plotInputs),createLabel("Separate By"),createDropdown(`group${n}`,plotInputs)]});}
var div=document.createElement("div");div.style.height="100%";div.style.zIndex=1;parent.appendChild(div);var form=new javaxt.dhtml.Form(div,{style:config.style.form,items:items});form.onChange=function(input,value){var key=input.name;chartConfig[key]=value;createBarPreview();};};var createLabel=function(label){var row=document.createElement("div");row.className="form-label";row.innerText=label+":";return{name:"",label:"",type:{getValue:function(){},setValue:function(){},el:row}};};var createDropdown=function(inputType,input){input[inputType]=new javaxt.dhtml.ComboBox(document.createElement("div"),{style:config.style.combobox,readOnly:true});return{name:inputType,label:"",type:input[inputType]};};var createBarPreview=function(){onRender(previewArea,function(){barChart.update(chartConfig,inputData);});};var editChart=function(){var styleEditor=getStyleEditor(config);var body=styleEditor.getBody();body.innerHTML="";var chartLayout=new javaxt.dhtml.ComboBox(document.createElement("div"),{style:config.style.combobox,readOnly:true});chartLayout.add("Vertical","vertical");chartLayout.add("Horizontal","horizontal");chartLayout.setValue("vertical");var form=new javaxt.dhtml.Form(body,{style:config.style.form,items:[{group:"General",items:[{name:"layout",label:"Chart Layout",type:chartLayout},{name:"legend",label:"Display Legend",type:"checkbox",options:[{label:"",value:true}]}]},{group:"X-Axis",items:[{name:"xLabel",label:"Show Labels",type:"checkbox",options:[{label:"",value:true}]},{name:"xGrid",label:"Show Grid Lines",type:"checkbox",options:[{label:"",value:true}]}]},{group:"Y-Axis",items:[{name:"yLabel",label:"Show Labels",type:"checkbox",options:[{label:"",value:true}]},{name:"yGrid",label:"Show Grid Lines",type:"checkbox",options:[{label:"",value:true}]}]},{group:"Histogram Options",items:[{name:"binWidth",label:"Bin Width",type:"text"}]}]});var layoutField=form.findField("layout");var layout=chartConfig.barLayout;layoutField.setValue(layout==="horizontal"?"horizontal":"vertical");var xGridField=form.findField("xGrid");var xGrid=chartConfig.xGrid;xGridField.setValue(xGrid===true?true:false);var yGridField=form.findField("yGrid");var yGrid=chartConfig.yGrid;yGridField.setValue(yGrid===true?true:false);var legendField=form.findField("legend");var legend=chartConfig.barLegend;legendField.setValue(legend===true?true:false);var xLabelField=form.findField("xLabel");var xLabel=chartConfig.xLabel;xLabelField.setValue(xLabel===true?true:false);var yLabelField=form.findField("yLabel");var yLabel=chartConfig.yLabel;yLabelField.setValue(yLabel===true?true:false);createSlider("binWidth",form,"",1,100,1);var binWidth=chartConfig.binWidth;if(isNaN(binWidth)||binWidth<1)binWidth=10;form.findField("binWidth").setValue(binWidth);form.onChange=function(){var settings=form.getData();if(settings.xGrid==="true")settings.xGrid=true;else settings.xGrid=false;if(settings.yGrid==="true")settings.yGrid=true;else settings.yGrid=false;if(settings.legend==="true")settings.legend=true;else settings.legend=false;if(settings.xLabel==="true")settings.xLabel=true;else settings.xLabel=false;if(settings.yLabel==="true")settings.yLabel=true;else settings.yLabel=false;chartConfig.barLayout=settings.layout;chartConfig.barLegend=settings.legend;chartConfig.xGrid=settings.xGrid;chartConfig.yGrid=settings.yGrid;chartConfig.xLabel=settings.xLabel;chartConfig.yLabel=settings.yLabel;chartConfig.binWidth=settings.binWidth;createBarPreview();};styleEditor.showAt(108,57);form.resize();};var editBar=function(datasetID){var styleEditor=getStyleEditor(config);var body=styleEditor.getBody();body.innerHTML="";var form=new javaxt.dhtml.Form(body,{style:config.style.form,items:[{group:"Fill Style",items:[{name:"barColor",label:"Color",type:new javaxt.dhtml.ComboBox(document.createElement("div"),{style:config.style.combobox})},{name:"fillOpacity",label:"Opacity",type:"text"}]}]});createColorOptions("barColor",form);createSlider("fillOpacity",form,"%");var fillOpacity=chartConfig.fillOpacity;if(isNaN(fillOpacity))fillOpacity=1;chartConfig.fillOpacity=fillOpacity;form.findField("fillOpacity").setValue(fillOpacity*100);if(datasetID!==null&&datasetID!==undefined){let n=`${datasetID}`;if(!chartConfig["barColor"+n])chartConfig["barColor"+n]="#6699CC";if(isNaN(chartConfig["fillOpacity"+n]))chartConfig["fillOpacity"+n]=1;form.findField("barColor").setValue(chartConfig["barColor"+n]);form.findField("fillOpacity").setValue(chartConfig["fillOpacity"+n]*100);form.onChange=function(){let settings=form.getData();chartConfig["barColor"+n]=settings.barColor;chartConfig["fillOpacity"+n]=settings.fillOpacity;createBarPreview();};}
styleEditor.showAt(108,57);form.resize();};var createColorOptions=function(inputName,form){bluewave.utils.createColorOptions(inputName,form,function(colorField){if(!colorPicker)colorPicker=bluewave.utils.createColorPickerCallout(config);var rect=javaxt.dhtml.utils.getRect(colorField.row);var x=rect.x+rect.width+15;var y=rect.y+(rect.height/2);colorPicker.showAt(x,y,"right","middle");colorPicker.setColor(colorField.getValue());colorPicker.onChange=function(color){colorField.setValue(color);};});};var merge=javaxt.dhtml.utils.merge;var onRender=javaxt.dhtml.utils.onRender;var createTable=javaxt.dhtml.utils.createTable;var createDashboardItem=bluewave.utils.createDashboardItem;var createSlider=bluewave.utils.createSlider;var addTextEditor=bluewave.utils.addTextEditor;var getStyleEditor=bluewave.utils.getStyleEditor;var getType=bluewave.chart.utils.getType;var parseData=bluewave.utils.parseData;init();};
if(!bluewave)var bluewave={};if(!bluewave.editor)bluewave.editor={};bluewave.editor.LineEditor=function(parent,config){var me=this;var defaultConfig={panel:{},chart:{}};var panel;var inputData=[];var previewArea;var lineChart,barChart;var optionsDiv;var plotInputs={};var chartConfig={layers:[]};var lineMap=[];var colorPicker;var init=function(){if(!config)config={};config=merge(config,defaultConfig);let table=createTable();let tbody=table.firstChild;var tr=document.createElement("tr");tbody.appendChild(tr);parent.appendChild(table);me.el=table;var td;td=document.createElement("td");td.style.height="100%";tr.appendChild(td);var outerDiv=document.createElement("div");outerDiv.className="chart-editor-options";outerDiv.style.height="100%";outerDiv.style.position="relative";outerDiv.style.overflow="hidden";outerDiv.style.overflowY="auto";td.appendChild(outerDiv);optionsDiv=document.createElement("div");optionsDiv.style.position="absolute";outerDiv.appendChild(optionsDiv);td=document.createElement("td");td.className="chart-editor-preview";td.style.width="100%";td.style.height="100%";tr.appendChild(td);var outerDiv=document.createElement("div");outerDiv.style.height="100%";outerDiv.style.position="relative";outerDiv.style.overflow="hidden";td.appendChild(outerDiv);panel=createDashboardItem(outerDiv,{width:"100%",height:"100%",title:"Untitled",settings:true});previewArea=panel.innerDiv;panel.el.className="";panel.el.style.position="absolute";addTextEditor(panel.title,function(title){panel.title.innerHTML=title;chartConfig.chartTitle=title;});panel.settings.onclick=function(){editChart();};lineChart=new bluewave.charts.LineChart(previewArea,{});lineChart.onClick=function(el,lineID){var line=lineChart.getLayers()[lineID+""].line;var layerID=lineMap[lineID].layer;editLine(line,layerID);};};this.update=function(node){me.clear();var clone={};merge(clone,node.config);merge(clone,config.chart);chartConfig=clone;for(var key in node.inputs){if(node.inputs.hasOwnProperty(key)){var inputNode=node.inputs[key];var data=parseData(inputNode.data,inputNode.config);if(data.length>0)inputData.push(data);}}
var addLayer=function(){chartConfig.layers.push({line:{fill:{},point:{}}});};if(!chartConfig.layers){chartConfig.layers=[];for(var i=0;i<inputData.length;i++){addLayer();}}
else{if(chartConfig.layers.length<inputData.length){var start=inputData.length-chartConfig.layers.length;for(var i=start;i<inputData.length;i++){addLayer();}}}
if(chartConfig.chartTitle){panel.title.innerHTML=chartConfig.chartTitle;}
createForm(optionsDiv);createOptions();};this.clear=function(){inputData=[];lineMap=[];chartConfig={};plotInputs={};panel.title.innerHTML="Untitled";optionsDiv.innerHTML="";if(lineChart)lineChart.clear();if(barChart)barChart.clear();if(colorPicker)colorPicker.hide();};this.getConfig=function(){return chartConfig;};this.getChart=function(){return previewArea;};this.renderChart=function(parent){var chart=new bluewave.charts.LineChart(parent,{});createLinePreview(chart);return chart;};var createOptions=function(){for(let i=0;i<inputData.length;i++){var n=i>0?(i+1):"";let xAxisN=`xAxis${n}`;let yAxisN=`yAxis${n}`;let groupN=`group${n}`;let labelN=`label${n}`;plotInputs[groupN].add("","");let dataOptions=Object.keys(inputData[i][0]);dataOptions.forEach((val)=>{plotInputs[xAxisN].add(val,val);plotInputs[yAxisN].add(val,val);plotInputs[groupN].add(val,val);});plotInputs[xAxisN].setValue(chartConfig.layers[i].xAxis,true);plotInputs[yAxisN].setValue(chartConfig.layers[i].yAxis,true);if(chartConfig.layers[i].group){plotInputs[groupN].setValue(chartConfig.layers[i].group,false);}
else{var label=chartConfig.layers[i].line.label;if(!label)label="Series "+(i+1);plotInputs[labelN].setValue(label,true);}}
createLinePreview(lineChart);};var createForm=function(parent){var items=[];for(var i=0;i<inputData.length;i++){var n=i>0?(i+1):"";items.push({group:"Series "+(i+1),items:[createLabel("X-Axis"),createDropdown(`xAxis${n}`,plotInputs),createLabel("Y-Axis"),createDropdown(`yAxis${n}`,plotInputs),createLabel("Separate By"),createDropdown(`group${n}`,plotInputs),createLabel("Name"),{name:(`label${n}`),label:"",type:"text"}]});}
var div=document.createElement("div");div.style.height="100%";div.style.zIndex=1;parent.appendChild(div);var form=new javaxt.dhtml.Form(div,{style:config.style.form,items:items});var formGroups=form.getGroups();for(var i=0;i<inputData.length;i++){var id=i>0?(i+1):"";var fieldName="label"+id;plotInputs[fieldName]=form.findField(fieldName);}
form.onChange=function(input,value){var datasetID;var foundGroup=false;formGroups.every(function(group){group.getRows().every(function(row){if(row===input.row){foundGroup=true;var groupName=group.name;var groupID=parseInt(groupName.substring(groupName.lastIndexOf(" ")));datasetID=groupID-1;}
return!foundGroup;});return!foundGroup;});var layer=chartConfig.layers[datasetID];var key=input.name;["xAxis","yAxis","group","label"].forEach(function(label){var idx=key.indexOf(label);if(key.includes(label)){if(label=="label"){layer.line.label=value;}
else{layer[label]=value;}}});var key=input.name;var idx=key.indexOf("group");if(idx>-1){var id=key.substring("group".length);var labelField=form.findField("label"+id);var labelText=labelField.row.previousSibling;if(!labelField.hide){addShowHide(labelField.row);addShowHide(labelText);}
if(value){labelField.row.hide();labelText.hide();}
else{labelField.row.show();labelText.show();}
form.resize();}
createLinePreview(lineChart);};};var createLabel=function(label){var row=document.createElement("div");row.className="form-label";row.innerText=label+":";return{name:"",label:"",type:{getValue:function(){},setValue:function(){},el:row}};};var createDropdown=function(inputType,input){input[inputType]=new javaxt.dhtml.ComboBox(document.createElement("div"),{style:config.style.combobox,readOnly:true});return{name:inputType,label:"",type:input[inputType]};};var createLinePreview=function(lineChart){lineChart.clear();lineChart.setConfig(chartConfig);var colors=bluewave.utils.getColorPalette(true);var addLine=function(line,data,xAxis,yAxis,layerID){lineChart.addLine(line,data,xAxis,yAxis);lineMap.push({layer:layerID});};var layers=chartConfig.layers;inputData.forEach(function(data,i){let layer=layers[i];if(layer.xAxis&&layer.yAxis){if(layer.group){var groupData=[];var map=d3.group(data,d=>d[layer.group]);for(const key of map.keys()){groupData.push({key:key,values:map.get(key)});}
var subgroups=groupData.map(function(d){return d["key"];});groupData.forEach(function(g,j){var d=g.values;let line=new bluewave.chart.Line();line.setColor(colors[j%colors.length]);line.setLabel(subgroups[j]);addLine(line,d,layer.xAxis,layer.yAxis,i);});}
else{if(!layer.line)layer.line={};var lineColor=layer.line.color;if(!lineColor){lineColor=colors[i%colors.length];layer.line.color=lineColor;}
let line=new bluewave.chart.Line(layer.line);addLine(line,data,layer.xAxis,layer.yAxis,i);}}});lineChart.update();};var editChart=function(){var styleEditor=getStyleEditor(config);var body=styleEditor.getBody();body.innerHTML="";var scaleDropdown=new javaxt.dhtml.ComboBox(document.createElement("div"),{style:config.style.combobox,readOnly:true});scaleDropdown.add("Linear","linear");scaleDropdown.add("Logarithmic","logarithmic");scaleDropdown.setValue("linear");var xMinDropdown=new javaxt.dhtml.ComboBox(document.createElement("div"),{style:config.style.combobox,readOnly:false});var xKeys=[];var layers=chartConfig.layers;inputData.forEach(function(data,i){let layer=layers[i];if(layer.xAxis){data.forEach((d)=>{xKeys.push(d[layer.xAxis]);});}});var xType=getType(xKeys);if(xType=="number"||xType=="currency"){var minX=Number.MAX_VALUE;var maxX=0;xKeys.forEach((key)=>{var n=bluewave.chart.utils.parseFloat(key);minX=Math.min(n,minX);maxX=Math.max(n,maxX);});xMinDropdown.add("0",0);if(minX!=0)xMinDropdown.add(minX+"",minX);xMinDropdown.setValue(0);}
var form=new javaxt.dhtml.Form(body,{style:config.style.form,items:[{group:"General",items:[{name:"scaleOptions",label:"Scaling Options",type:scaleDropdown},{name:"endTags",label:"Display End Tags",type:"checkbox",options:[{label:"",value:true,checked:true}]},{name:"accumulate",label:"Accumulate Values",type:"checkbox",options:[{label:"",value:true,checked:false}]},{name:"stack",label:"Stack Lines",type:"checkbox",options:[{label:"",value:true,checked:false}]}]},{group:"X-Axis",items:[{name:"xLabel",label:"Show Labels",type:"checkbox",options:[{label:"",value:true}]},{name:"xGrid",label:"Show Grid Lines",type:"checkbox",options:[{label:"",value:true}]},{name:"xMin",label:"Min Value",type:xMinDropdown},{name:"xTicks",label:"Ticks",type:"text"}]},{group:"Y-Axis",items:[{name:"yLabel",label:"Show Labels",type:"checkbox",options:[{label:"",value:true}]},{name:"yGrid",label:"Show Grid Lines",type:"checkbox",options:[{label:"",value:true}]}]}]});var xGridField=form.findField("xGrid");var xGrid=chartConfig.xGrid;xGridField.setValue(xGrid===true?true:false);var yGridField=form.findField("yGrid");var yGrid=chartConfig.yGrid;yGridField.setValue(yGrid===true?true:false);var xLabelField=form.findField("xLabel");var xLabel=chartConfig.xLabel;xLabelField.setValue(xLabel?true:false);var yLabelField=form.findField("yLabel");var yLabel=chartConfig.yLabel;yLabelField.setValue(yLabel?true:false);var tagField=form.findField("endTags");var endTags=chartConfig.endTags;tagField.setValue(endTags===true?true:false);var stackField=form.findField("stack");var stack=chartConfig.stackValues;stackField.setValue(stack===true?true:false);var accumulateField=form.findField("accumulate");var accumulate=chartConfig.accumulateValues;accumulateField.setValue(accumulate===true?true:false);var scalingField=form.findField("scaleOptions");var scale=chartConfig.scaling;scalingField.setValue(scale==="logarithmic"?"logarithmic":"linear");createSlider("xTicks",form,"",0,50,1);var xTicks=chartConfig.xTicks;if(isNaN(xTicks))xTicks=10;form.findField("xTicks").setValue(xTicks);form.onChange=function(){var settings=form.getData();if(settings.xGrid==="true")settings.xGrid=true;else settings.xGrid=false;if(settings.yGrid==="true")settings.yGrid=true;else settings.yGrid=false;if(settings.xLabel)settings.xLabel=true;else settings.xLabel=false;if(settings.yLabel)settings.yLabel=true;else settings.yLabel=false;if(settings.endTags==="true")settings.endTags=true;else settings.endTags=false;if(settings.stack==="true")settings.stack=true;else settings.stack=false;if(settings.accumulate==="true")settings.accumulate=true;else settings.accumulate=false;chartConfig.scaling=settings.scaleOptions;chartConfig.xGrid=settings.xGrid;chartConfig.yGrid=settings.yGrid;chartConfig.xLabel=settings.xLabel;chartConfig.yLabel=settings.yLabel;chartConfig.endTags=settings.endTags;chartConfig.stackValues=settings.stack;chartConfig.accumulateValues=settings.accumulate;if(chartConfig.xLabel)chartConfig.xLabel=chartConfig.layers[0].xAxis;if(chartConfig.yLabel)chartConfig.yLabel=chartConfig.layers[0].yAxis;chartConfig.xTicks=settings.xTicks;var xMin=bluewave.chart.utils.parseFloat(xMinDropdown.getText());if(!isNaN(xMin))chartConfig.xMin=xMin;createLinePreview(lineChart);};styleEditor.showAt(108,57);form.resize();};var editLine=function(line,layerID){var styleEditor=getStyleEditor(config);var body=styleEditor.getBody();body.innerHTML="";var lineDropdown=new javaxt.dhtml.ComboBox(document.createElement("div"),{style:config.style.combobox,readOnly:true});lineDropdown.add("Solid","solid");lineDropdown.add("Dashed","dashed");lineDropdown.add("Dotted","dotted");lineDropdown.setValue("solid");var smoothingDropdown=new javaxt.dhtml.ComboBox(document.createElement("div"),{style:config.style.combobox,readOnly:true});smoothingDropdown.add("None","none");smoothingDropdown.add("Simple Spline","spline");smoothingDropdown.add("Moving Average","movingAverage");smoothingDropdown.add("Kernel Density Estimation","kde");smoothingDropdown.setValue("none");var form=new javaxt.dhtml.Form(body,{style:config.style.form,items:[{group:"Stroke",items:[{name:"lineStyle",label:"Type",type:lineDropdown},{name:"lineColor",label:"Color",type:new javaxt.dhtml.ComboBox(document.createElement("div"),{style:config.style.combobox})},{name:"lineThickness",label:"Thickness",type:"text"},{name:"lineOpacity",label:"Opacity",type:"text"}]},{group:"Points",items:[{name:"pointColor",label:"Color",type:new javaxt.dhtml.ComboBox(document.createElement("div"),{style:config.style.combobox})},{name:"pointRadius",label:"Radius",type:"text"}]},{group:"Fill",items:[{name:"startOpacity",label:"Start Opacity",type:"text"},{name:"endOpacity",label:"End Opacity",type:"text"}]},{group:"Smoothing",items:[{name:"smoothingType",label:"Type",type:smoothingDropdown},{name:"smoothingValue",label:"Factor",type:"text"}]}]});createColorOptions("lineColor",form);createColorOptions("pointColor",form);var lineConfig=line.getConfig();createSlider("lineThickness",form,"px",1,10,1);var thickness=lineConfig.width;if(isNaN(thickness))thickness=1;form.findField("lineThickness").setValue(thickness);createSlider("lineOpacity",form,"%");var opacity=lineConfig.opacity;if(isNaN(opacity))opacity=1;form.findField("lineOpacity").setValue(opacity*100);createSlider("startOpacity",form,"%");var startOpacity=lineConfig.fill.startOpacity;if(isNaN(startOpacity))startOpacity=0;form.findField("startOpacity").setValue(startOpacity*100);createSlider("endOpacity",form,"%");var endOpacity=lineConfig.fill.endOpacity;if(isNaN(endOpacity))endOpacity=0;form.findField("endOpacity").setValue(endOpacity*100);createSlider("pointRadius",form,"px",0,10,1);var pointRadius=lineConfig.point.radius;if(isNaN(pointRadius))pointRadius=0;form.findField("pointRadius").setValue(pointRadius);var smoothingField=form.findField("smoothingValue");var smoothingSlider=createSlider("smoothingValue",form,"",0,100,1);var smoothingValue=lineConfig.smoothingValue;if(isNaN(smoothingValue))smoothingValue=0;smoothingField.setValue(smoothingValue);form.findField("lineColor").setValue(lineConfig.color);form.findField("pointColor").setValue(lineConfig.point.color);form.findField("pointRadius").setValue(lineConfig.point.radius);form.findField("lineStyle").setValue(lineConfig.style);form.findField("lineThickness").setValue(lineConfig.width);form.findField("lineOpacity").setValue(lineConfig.opacity*100);form.findField("startOpacity").setValue(lineConfig.fill.startOpacity*100);form.findField("endOpacity").setValue(lineConfig.fill.endOpacity*100);var smoothingType=lineConfig.smoothing;if(smoothingType){form.findField("smoothingType").setValue(smoothingType);var smoothingValue=lineConfig.smoothingValue;if(isNaN(smoothingValue))smoothingValue=0;smoothingField.setValue(smoothingValue);}
else{smoothingField.setValue(0);form.disableField("smoothingValue");smoothingSlider.disabled=true;}
form.onChange=function(){let settings=form.getData();lineConfig.color=settings.lineColor;lineConfig.style=settings.lineStyle;lineConfig.width=settings.lineThickness;lineConfig.opacity=settings.lineOpacity/100;lineConfig.fill.color=settings.lineColor;lineConfig.fill.startOpacity=settings.startOpacity/100;lineConfig.fill.endOpacity=settings.endOpacity/100;lineConfig.point.color=settings.pointColor;lineConfig.point.radius=settings.pointRadius;var smoothingType=settings.smoothingType;if(smoothingType==="none"){lineConfig.smoothing="none";lineConfig.smoothingValue=0;form.disableField("smoothingValue");smoothingSlider.disabled=true;}
else if(smoothingType==="spline"){lineConfig.smoothing=smoothingType;lineConfig.smoothingValue=0;form.disableField("smoothingValue");smoothingSlider.disabled=true;}
else{lineConfig.smoothing=smoothingType;lineConfig.smoothingValue=settings.smoothingValue;form.enableField("smoothingValue");smoothingSlider.disabled=false;}
smoothingSlider.focus();line.setConfig(lineConfig);lineChart.update();var layer=chartConfig.layers[layerID];if(layer.group){}
else{chartConfig.layers[layerID].line=line.getConfig();}};styleEditor.showAt(108,57);form.resize();};var createColorOptions=function(inputName,form){bluewave.utils.createColorOptions(inputName,form,function(colorField){if(!colorPicker)colorPicker=bluewave.utils.createColorPickerCallout(config);var rect=javaxt.dhtml.utils.getRect(colorField.row);var x=rect.x+rect.width+15;var y=rect.y+(rect.height/2);colorPicker.showAt(x,y,"right","middle");colorPicker.setColor(colorField.getValue());colorPicker.onChange=function(color){colorField.setValue(color);};});};var merge=javaxt.dhtml.utils.merge;var addShowHide=javaxt.dhtml.utils.addShowHide;var createTable=javaxt.dhtml.utils.createTable;var createDashboardItem=bluewave.utils.createDashboardItem;var createSlider=bluewave.utils.createSlider;var addTextEditor=bluewave.utils.addTextEditor;var getStyleEditor=bluewave.utils.getStyleEditor;var getType=bluewave.chart.utils.getType;var parseData=bluewave.utils.parseData;init();};
if(!bluewave)var bluewave={};if(!bluewave.editor)bluewave.editor={};bluewave.editor.MapEditor=function(parent,config){var me=this;var defaultConfig={panel:{},colors:bluewave.utils.getColorGradients(),chart:{style:{backgroundColor:"#fff",landColor:"#dedde0"}},data:{politicalBoundaries:"data/"}};var chartConfig={};var panel;var previewArea;var mapChart;var inputData=[];var mapInputs={};var styleEditor,colorPicker;var counties,states,countries;var options=[];var init=function(){if(!config)config={};config=merge(config,defaultConfig);chartConfig=config.chart;let table=createTable(parent);var tr=table.addRow();me.el=table;var td;td=tr.addColumn();let div=document.createElement("div");div.className="chart-editor-options";td.appendChild(div);createInput(div,"mapType","Map Type",showHideDropDowns);createInput(div,"mapLevel","Map Level",showHideDropDowns);createInput(div,"pointData","Point Data",showHideDropDowns);createInput(div,"latitude","Latitude",createMapPreview,"lat");createInput(div,"longitude","Longitude",createMapPreview,"long");createInput(div,"mapLocation","Location Data",createMapPreview);createInput(div,"mapValue","Value",createMapPreview);createInput(div,"mapProjectionName","Projection",createMapPreview);td=tr.addColumn();td.className="chart-editor-preview";td.style.width="100%";td.style.height="100%";panel=createDashboardItem(td,{width:"100%",height:"100%",title:"Untitled",settings:true});panel.el.className="";previewArea=panel.innerDiv;mapChart=new bluewave.charts.MapChart(previewArea,chartConfig);mapChart.disablePan();addTextEditor(panel.title,function(title){panel.title.innerHTML=title;chartConfig.chartTitle=title;});panel.settings.onclick=function(){if(chartConfig)editStyle(chartConfig.mapType,chartConfig.mapLevel);};};this.clear=function(){inputData=[];chartConfig={};panel.title.innerHTML="Untitled";if(mapInputs){for(var key in mapInputs){if(mapInputs.hasOwnProperty(key)){var mapInput=mapInputs[key];if(mapInput){if(mapInput.clear)mapInput.clear();if(mapInput.hide)mapInput.hide();}}}}
if(mapChart)mapChart.clear();};this.update=function(node){me.clear();var clone={};merge(clone,node.config);merge(clone,config.chart);chartConfig=clone;for(var key in node.inputs){if(node.inputs.hasOwnProperty(key)){var inputNode=node.inputs[key];var data=parseData(inputNode.data,inputNode.config);if(data.length>0)inputData.push(data);else{var inputConfig=inputNode.config;if(inputConfig)inputData.push(inputConfig);}}}
if(chartConfig.chartTitle){panel.title.innerHTML=chartConfig.chartTitle;}
chartConfig.mapLevel=getMapLevel(chartConfig);var data=inputData[0];if(isArray(data)){var numericFields=[];var stringFields=[];Object.keys(data[0]).forEach((field)=>{var values=[];data.forEach((d)=>{var val=d[field];values.push(val);});var type=getType(values);if(type=="string")stringFields.push(field);if(type=="number")numericFields.push(field);});numericFields.forEach((field)=>{mapInputs.lat.add(field,field);mapInputs.long.add(field,field);mapInputs.mapValue.add(field,field);});stringFields.forEach((field)=>{mapInputs.mapLocation.add(field,field);});mapInputs.mapType.add("Point","Point");mapInputs.mapType.add("Area","Area");mapInputs.pointData.add("Geographic Coordinates","geoCoords");mapInputs.pointData.add("Admin Area","adminArea");mapInputs.mapLevel.add("States","counties");mapInputs.mapLevel.add("Country","states");mapInputs.mapLevel.add("World","world");}
else{chartConfig.mapType="Links";chartConfig.mapValue="quantity";chartConfig.mapLevel="world";mapInputs.mapType.add("Links","Links");mapInputs.mapValue.add("quantity","quantity");mapInputs.mapLevel.add("Country","states");mapInputs.mapLevel.add("World","world");}
mapInputs.mapType.show();mapInputs.mapLevel.show();mapInputs.mapValue.show();if(chartConfig.mapType==="Point"){mapInputs.pointData.show();if(chartConfig.pointData==="geoCoords"){if(chartConfig.latitude&&chartConfig.longitude){mapInputs.lat.show();mapInputs.long.show();}}}
mapInputs.mapType.setValue(chartConfig.mapType,false);mapInputs.mapLevel.setValue(chartConfig.mapLevel,true);mapInputs.mapValue.setValue(chartConfig.mapValue,true);mapInputs.pointData.setValue(chartConfig.pointData,true);mapInputs.lat.setValue(chartConfig.latitude,true);mapInputs.long.setValue(chartConfig.longitude,true);createMapPreview();};this.resize=function(){if(mapChart)mapChart.resize();};var createInput=function(parent,chartConfigRef,displayName,onChange,inputType){if(!inputType)inputType=chartConfigRef;var row=document.createElement("div");parent.appendChild(row);addShowHide(row);var label=document.createElement("label");label.innerText=displayName+":";row.appendChild(label);var input=new javaxt.dhtml.ComboBox(row,{style:config.style.combobox,readOnly:true});input.onChange=function(name,value){chartConfig[chartConfigRef]=value;var args=[];if(onChange===showHideDropDowns)args=[inputType,name,value];onChange.apply(input,args);};var show=input.show;input.show=function(){show();row.show();};var hide=input.hide;input.hide=function(){hide();row.hide();};input.hide();mapInputs[inputType]=input;};var showHideDropDowns=function(inputType,name,value){if(inputType==="mapType"){if(value==="Point"){mapInputs.mapLocation.hide();mapInputs.mapValue.show();mapInputs.pointData.show();}
else if(value==="Area"){mapInputs.lat.hide();mapInputs.long.hide();mapInputs.mapLocation.show();mapInputs.mapValue.show();mapInputs.pointData.hide();}}
else if(inputType==="pointData"){if(value==="geoCoords"){mapInputs.lat.show();mapInputs.long.show();mapInputs.mapLocation.hide();}
else if(value==="adminArea"){mapInputs.lat.hide();mapInputs.long.hide();mapInputs.mapLocation.show();}}
else if(inputType==="mapLevel"){delete chartConfig.lon;delete chartConfig.lat;createMapPreview();}};var createMapPreview=function(chart){if(!chartConfig.mapType)return;if(!chartConfig.mapLevel)return;if(chartConfig.mapType==="Point"&&chartConfig.pointData===null)return;if(chartConfig.mapType==="Point"&&(chartConfig.pointData==="geoCoords"&&(chartConfig.latitude===null||chartConfig.longitude===null||chartConfig.mapValue===null))){return;}
if(chartConfig.mapType==="Point"&&(chartConfig.pointData==="adminArea"&&(chartConfig.mapLocation===null||chartConfig.mapValue===null))){return;}
if(chartConfig.mapType==="Area"&&(chartConfig.mapValue===null||chartConfig.mapLocation===null)){return;}
if(chartConfig.mapType==="Links"&&(chartConfig.mapValue==null||chartConfig.mapLocation===null)){return;}
getMapData(()=>{if(!(chart instanceof bluewave.charts.MapChart))chart=mapChart;update(chart,inputData[0]);});};this.getConfig=function(){return chartConfig;};this.getChart=function(){return previewArea;};this.renderChart=function(parent){var chart=new bluewave.charts.MapChart(parent,chartConfig);createMapPreview(chart);return chart;};var editStyle=function(mapType,mapLevel){if(!styleEditor){styleEditor=new javaxt.dhtml.Window(document.body,{title:"Edit Style",width:400,valign:"top",modal:false,resizable:false,style:config.style.window});}
var form;var body=styleEditor.getBody();body.innerHTML="";var mapColors={group:"Map Colors",items:[{name:"backgroundColor",label:"Background",type:new javaxt.dhtml.ComboBox(document.createElement("div"),{style:config.style.combobox})},{name:"landColor",label:"Land",type:new javaxt.dhtml.ComboBox(document.createElement("div"),{style:config.style.combobox})}]};var mapCenter={group:"Map Center",items:[{name:"centerHorizontal",label:"Longitude",type:"text"},{name:"centerVertical",label:"Latitude",type:"text"}]};if(mapType==="Point"){var formItems=[{group:"Point Style",items:[{name:"color",label:"Color",type:new javaxt.dhtml.ComboBox(document.createElement("div"),{style:config.style.combobox})},{name:"radius",label:"Radius",type:"text"},{name:"opacity",label:"Opacity",type:"text"},{name:"outlineWidth",label:"Border Width",type:"text"},{name:"outlineColor",label:"Border Color",type:new javaxt.dhtml.ComboBox(document.createElement("div"),{style:config.style.combobox})}]},mapColors];if(mapLevel==="states"||mapLevel==="world"){}
form=new javaxt.dhtml.Form(body,{style:config.style.form,items:formItems});createColorOptions("color",form);createColorOptions("backgroundColor",form);createColorOptions("landColor",form);var pointFill=chartConfig.pointColor||"#ff3c38";form.findField("color").setValue(pointFill);form.findField("backgroundColor").setValue(chartConfig.style.backgroundColor);form.findField("landColor").setValue(chartConfig.style.landColor);createColorOptions("outlineColor",form);form.findField("outlineColor").setValue(chartConfig.outlineColor||pointFill);createSlider("radius",form,"px",1,20,1);var radius=chartConfig.pointRadius;if(radius==null)radius=3;chartConfig.pointRadius=radius;form.findField("radius").setValue(radius);createSlider("opacity",form,"%");var opacity=chartConfig.opacity;if(opacity==null)opacity=100;chartConfig.opacity=opacity;form.findField("opacity").setValue(opacity);createSlider("outlineWidth",form,"px",0,20,1);var outlineWidth=chartConfig.outlineWidth;if(outlineWidth==null)outlineWidth=0;chartConfig.outlineWidth=outlineWidth;form.findField("outlineWidth").setValue(outlineWidth);if(mapLevel==="states"||mapLevel==="world"){var horizontalField=form.findField("centerHorizontal");if(horizontalField){var horizontal=chartConfig.lon;if(horizontal==null){if(mapLevel==="states"){horizontal=38.7}else{horizontal=39.5;}}
chartConfig.lon=horizontal;horizontalField.setValue(horizontal);}
var verticalField=form.findField("centerVertical");if(verticalField){var vertical=chartConfig.lat;if(vertical==null){if(mapLevel==="states"){vertical=-0.6}else{vertical=-98.5;}}
chartConfig.lat=vertical;verticalField.setValue(vertical);}
form.onChange=function(){var settings=form.getData();chartConfig.pointColor=settings.color;chartConfig.outlineColor=settings.outlineColor;chartConfig.pointRadius=settings.radius;chartConfig.opacity=settings.opacity;chartConfig.outlineWidth=settings.outlineWidth;chartConfig.style.landColor=settings.landColor;chartConfig.style.backgroundColor=settings.backgroundColor;chartConfig.lon=settings.centerHorizontal;chartConfig.lat=settings.centerVertical;createMapPreview();};}
else{form.onChange=function(){var settings=form.getData();chartConfig.pointColor=settings.color;chartConfig.outlineColor=settings.outlineColor;chartConfig.style.landColor=settings.landColor;chartConfig.style.backgroundColor=settings.backgroundColor;chartConfig.pointRadius=settings.radius;chartConfig.outlineWidth=settings.outlineWidth;chartConfig.opacity=settings.opacity;createMapPreview();};}}
else if(mapType==="Area"){if(mapLevel==="states"||mapLevel==="world"){form=new javaxt.dhtml.Form(body,{style:config.style.form,items:[{group:"Fill Style",items:[{name:"fillColors",label:"Color",type:createColorField()}]},mapColors]});createColorOptions("backgroundColor",form);createColorOptions("landColor",form);form.findField("backgroundColor").setValue(chartConfig.style.backgroundColor);form.findField("landColor").setValue(chartConfig.style.landColor);var horizontalField=form.findField("centerHorizontal");if(horizontalField){var horizontal=chartConfig.lon;if(horizontal==null){if(mapLevel==="states"){horizontal=38.7;}else{horizontal=39.5;}}
chartConfig.lon=horizontal;horizontalField.setValue(horizontal);}
var verticalField=form.findField("centerVertical");if(verticalField){var vertical=chartConfig.lat;if(vertical==null){if(mapLevel==="states"){vertical=-0.6;}else{vertical=-98.5;}}
chartConfig.lat=vertical;verticalField.setValue(vertical);}
form.onChange=function(){var settings=form.getData();chartConfig.fillColors=JSON.parse(settings.fillColors);chartConfig.style.landColor=settings.landColor;chartConfig.style.backgroundColor=settings.backgroundColor;chartConfig.lon=settings.centerHorizontal;chartConfig.lat=settings.centerVertical;createMapPreview();};}
else if(mapLevel==="counties"){form=new javaxt.dhtml.Form(body,{style:config.style.form,items:[{group:"Fill Style",items:[{name:"fillColors",label:"Color",type:createColorField()}]},mapColors]});createColorOptions("backgroundColor",form);createColorOptions("landColor",form);form.findField("backgroundColor").setValue(chartConfig.style.backgroundColor);form.findField("landColor").setValue(chartConfig.style.landColor);form.onChange=function(){var settings=form.getData();chartConfig.fillColors=JSON.parse(settings.fillColors);chartConfig.style.landColor=settings.landColor;chartConfig.style.backgroundColor=settings.backgroundColor;createMapPreview();};}}
else if(mapType==="Links"){if(mapLevel==="states"||mapLevel==="world"){form=new javaxt.dhtml.Form(body,{style:config.style.form,items:[mapColors]});createColorOptions("backgroundColor",form);createColorOptions("landColor",form);form.findField("backgroundColor").setValue(chartConfig.style.backgroundColor);form.findField("landColor").setValue(chartConfig.style.landColor);var horizontalField=form.findField("centerHorizontal");if(horizontalField){var horizontal=chartConfig.lon;if(horizontal==null){if(mapLevel==="states"){horizontal=38.7}else{horizontal=39.5;}}
chartConfig.lon=horizontal;horizontalField.setValue(horizontal);}
var verticalField=form.findField("centerVertical");if(verticalField){var vertical=chartConfig.lat;if(vertical==null){if(mapLevel==="states"){vertical=-0.6}else{vertical=-98.5;}}
chartConfig.lat=vertical;verticalField.setValue(vertical);}
form.onChange=function(){var settings=form.getData();chartConfig.lon=settings.centerHorizontal;chartConfig.lat=settings.centerVertical;chartConfig.style.landColor=settings.landColor;chartConfig.style.backgroundColor=settings.backgroundColor;createMapPreview();};}}
if(form){styleEditor.showAt(108,57);form.resize();}};var getMapLevel=function(chartConfig){if(!chartConfig.mapLevel)return null;var mapLevel=chartConfig.mapLevel.toLowerCase();if(mapLevel.indexOf("census")>-1)return"states";if(mapLevel.indexOf("states")>-1)return"states";if(mapLevel.indexOf("counties")>-1)return"counties";if(mapLevel.indexOf("countries")>-1||mapLevel.indexOf("world")>-1)return"world";return mapLevel;};var createColorField=function(){var colorField=bluewave.utils.createColorField({colors:config.colors,style:config.style});var fillColors=getFillColors();colorField.setValue(JSON.stringify(fillColors));return colorField;};var createColorOptions=function(inputName,form){bluewave.utils.createColorOptions(inputName,form,function(colorField){if(!colorPicker){colorPicker=bluewave.utils.createColorPickerCallout({style:config.style});}
var colors;if(inputName==="backgroundColor"){colors=["#fff","#e5ecf4"];}
else if(inputName==="landColor"){colors=["#f6f8f5","#dedde0"];}
else{colors=bluewave.utils.getColorPalette(true);}
colorPicker.setColors(colors);colorPicker.setColor(colorField.getValue());var rect=javaxt.dhtml.utils.getRect(colorField.row);var x=rect.x+rect.width+15;var y=rect.y+(rect.height/2);colorPicker.showAt(x,y,"right","middle");colorPicker.onChange=function(color){colorField.setValue(color);};});};var update=function(mapChart,data){mapChart.clear();var backgroundColor=chartConfig.style.backgroundColor;if(!backgroundColor)backgroundColor="white";mapChart.setBackgroundColor(backgroundColor);var landColor=getDefaultFillColor();var extent=d3.extent(data,function(d){return parseFloat(d[chartConfig.mapValue]);});var fillColors;if(chartConfig.mapType==="Area"){fillColors=getFillColors();}
var mapLevel=chartConfig.mapLevel;if(mapLevel==="counties"){mapChart.setProjection("AlbersUsa");if(chartConfig.mapType==="Point"){renderCounties();renderStates();var points={};if(chartConfig.pointData==="geoCoords"){points=getPoints(data,chartConfig);}
else if(chartConfig.pointData==="adminArea"){points=getCentroids(data,states);}
renderPoints(points,chartConfig,extent);}
else if(chartConfig.mapType==="Area"){var area=selectArea(data,chartConfig);if(area==="counties"){renderCounties(data,fillColors,landColor);renderStates();}
else if(area==="states"){renderStates(data,fillColors,landColor);}
else if(area==="censusDivisions"){renderCensusRegions(data,fillColors,landColor);}
else{renderCounties();renderStates();}}}
else if(mapLevel==="states"){mapChart.setProjection("Albers");mapChart.setExtent([-130,40.5],[-65,25.8]);renderCountries();if(chartConfig.mapType==="Point"){renderStates();var points={};if(chartConfig.pointData==="geoCoords"){points=getPoints(data,chartConfig);}
else if(chartConfig.pointData==="adminArea"){points=getCentroids(data,states);}
renderPoints(points,chartConfig,extent);}
else if(chartConfig.mapType==="Area"){var area=selectArea(data,chartConfig);if(area==="counties"){renderCounties(data,fillColors,landColor);renderStates();}
else if(area==="states"){renderStates(data,fillColors,landColor);}
else if(area==="censusDivisions"){renderCensusRegions(data,fillColors,landColor);}
else{renderStates();}}
else if(chartConfig.mapType==="Links"){getData("PortsOfEntry",function(ports){mapChart.clear();renderCountries();renderLinks(data,ports);});}}
else if(mapLevel==="world"){mapChart.setProjection("Mercator");mapChart.setExtent([-170,76],[170,-76]);if(chartConfig.mapType==="Point"){renderCountries();var points={};if(chartConfig.pointData==="geoCoords"){points=getPoints(data,chartConfig);}
else if(chartConfig.pointData==="adminArea"){points=getCentroids(data,countries);}
renderPoints(points,chartConfig,extent);}
else if(chartConfig.mapType==="Area"){var fill=new Fill(data,fillColors);mapChart.addPolygons(countries.features,{name:"countries",style:{fill:function(feature){return fill.getColor(feature.properties.code,landColor);},stroke:"white"},showTooltip:true,getTooltipLabel:function(feature){var name=feature.properties.name;var value=fill.getValue(feature.properties.code);if(isNaN(value))value="No data";return name+": "+value;}});}
else if(chartConfig.mapType==="Links"){getData("PortsOfEntry",function(ports){mapChart.clear();renderCountries();renderLinks(data,ports);});}}
mapChart.update();};var renderLinks=function(data,ports){var getColor=d3.scaleOrdinal(bluewave.utils.getColorPalette(true));var coords=[];var quantities=[];var countryCodes={};var getCoordinate=function(countryCode,countries){for(var i=0;i<countries.features.length;i++){var country=countries.features[i].properties;if(countryCode===country.code){return[country.longitude,country.latitude];}}};for(var link in data.links){if(data.links.hasOwnProperty(link)){var arr=link.split('->');var n0=data.nodes[arr[0]];var n1=data.nodes[arr[1]];var q=data.links[link].quantity;if(n0.country==='US'){coords.push(getCoordinate(n0.state,states));}
else{coords.push(getCoordinate(n0.country,countries));}
if(n0.country!=='US'&&n1.country==='US'){for(var i=0;i<ports.length;i++){var port=ports[i];if(n0.country===ports[i].iso2){coords.push([port.exlongitude,port.exlatitude]);coords.push([port.imlongitude,port.imlatitude]);break;}}}
if(n1.country==='US'){coords.push(getCoordinate(n1.state,states));}
else{coords.push(getCoordinate(n1.country,countries));}
quantities.push(q);countryCodes[n0.country]=true;countryCodes[n1.country]=true;}}
if(countryCodes['US']){countryCodes=Object.keys(countryCodes);if(countryCodes.length===1&&countryCodes[0]==="US"){mapChart.setExtent([-130,50.5],[-65,25.8]);}
else{mapChart.setExtent([60,74],[59,-58]);}}
else{mapChart.setExtent([-170,76],[170,-76]);}
mapChart.addLines([coords],{name:"links",style:{color:"steelblue",opacity:0.5,width:3}});mapChart.addPoints(coords,{name:"nodes",style:{fill:"#FF0000",opacity:0.5,radius:4}});mapChart.update();};var getPoints=function(data,chartConfig){var coords=[];var hasValue=false;data.forEach(function(d){var lat=parseFloat(d[chartConfig.latitude]);var lon=parseFloat(d[chartConfig.longitude]);if(isNaN(lat)||isNaN(lon))return;var coord=[lon,lat];if(!coord)return;if(isNaN(coord[0])||isNaN(coord[1]))return;var val=parseFloat(d[chartConfig.mapValue]);if(!isNaN(val)){coord.push(val);hasValue=true;}
coords.push(coord);});return{coords:coords,hasValue:hasValue};};var getCentroids=function(data,mapData){var coords=[];var hasValue=false;data.forEach(function(d){var value=d[chartConfig.mapLocation];mapData.features.every(function(feature){var properties=feature.properties;if(value===properties.code){var centroid;if(!isNaN(properties.latitude)&&!isNaN(properties.longitude)){centroid=[properties.longitude,properties.latitude];}
else{centroid=mapChart.getCentroid(feature);}
if(centroid){if(isNaN(centroid[0])||isNaN(centroid[0]))centroid=null;else coords.push(centroid);}
if(centroid&&chartConfig.mapValue){var val=parseFloat(d[chartConfig.mapValue]);if(!isNaN(val)){hasValue=true;centroid.push(val);}}
return false;}
return true;});});return{coords:coords,hasValue:hasValue};};var renderPoints=function(points,chartConfig,extent){var opacity=chartConfig.opacity;if(!opacity){opacity=1.0;}
else{opacity=opacity/100;}
var r=parseInt(chartConfig.pointRadius);if(isNaN(r))r=3;if(r<0)r=1;var c=chartConfig.pointColor||"#ff3c38";var oc=chartConfig.outlineColor;if(!oc)oc=c;var outlineWidth=parseFloat(chartConfig.outlineWidth);if(isNaN(outlineWidth)||outlineWidth<0)outlineWidth=0;if(outlineWidth>r)outlineWidth=r;mapChart.addPoints(points.coords,{name:"points",style:{fill:c,opacity:opacity,radius:function(coord){if(points.hasValue){var val=coord[2];if(isNaN(val)||val<=0)return r;var p=val/extent[1];var maxSize=r;if(p>0){return maxSize*p;}
else{return maxSize*.25;}}
return r;},outlineWidth:outlineWidth,outlineColor:oc}});};var selectArea=function(data,chartConfig){var numStates=0;var numCounties=0;var numCensusDivisions=0;data.forEach(function(d){var location=d[chartConfig.mapLocation];if(typeof location==='undefined')return;var censusDivision=getCensusDivision(d[chartConfig.mapLocation]);counties.features.every(function(county){if(county.id===location){numCounties++;return false;}
return true;});states.features.every(function(state){var foundMatch=false;if(state.properties.name===location||state.properties.code===location){numStates++;foundMatch=true;}
if(!isNaN(censusDivision)){if(state.properties.censusDivision===censusDivision){numCensusDivisions++;foundMatch=true;}}
return!foundMatch;});});var maxMatches=Math.max(numStates,numCounties,numCensusDivisions);if(maxMatches>0){if(maxMatches===numCounties){return"counties";}
else if(maxMatches===numStates){return"states";}
else if(maxMatches===numCensusDivisions){return"censusDivisions";}}
return null;};var renderCounties=function(data,fillColors,defaultFillColor){if(!defaultFillColor)defaultFillColor=getDefaultFillColor();var fill;if(data&&fillColors){fill=new Fill(data,fillColors);}
mapChart.addPolygons(counties.features,{name:"counties",style:{fill:function(feature){if(fill){return fill.getColor(feature.id,defaultFillColor);}
else{return defaultFillColor;}},stroke:"white"},showTooltip:fill?true:false,getTooltipLabel:function(feature){var name=feature.id;var value=fill.getValue(feature.id);if(isNaN(value))value="No data";return name+": "+value;}});};var renderStates=function(data,fillColors,defaultFillColor){if(!defaultFillColor)defaultFillColor=getDefaultFillColor();var fill;if(data&&fillColors){fill=new Fill(data,fillColors);}
mapChart.addPolygons(states.features,{name:"states",style:{fill:function(feature){if(fill){var key=feature.properties.name;var value=fill.getValue(key);if(isNaN(value)){key=feature.properties.code;value=fill.getValue(key);}
return fill.getColor(key,defaultFillColor);}
else{return defaultFillColor;}},stroke:"white"},showTooltip:fill?true:false,getTooltipLabel:function(feature){var name=feature.properties.name;var value=fill.getValue(feature.properties.name);if(isNaN(value))value="No data";return name+": "+value;}});};var renderCensusRegions=function(data,fillColors,defaultFillColor){if(!defaultFillColor)defaultFillColor=getDefaultFillColor();var fill;if(data&&fillColors){fill=new Fill(data,fillColors);}
var values={};data.forEach(function(d){var censusDivision=getCensusDivision(d[chartConfig.mapLocation]);if(!isNaN(censusDivision)){values[censusDivision+""]=d[chartConfig.mapValue];}});mapChart.addPolygons(states.features,{name:"censusRegions",style:{fill:function(state){var v=parseFloat(values[state.properties.censusDivision+""]);if(isNaN(v)||v<0)v=0;var fill=colorScale[chartConfig.colorScale](v);if(!fill)return'none';return fill;},stroke:"white"},showTooltip:fill?true:false});};var renderCountries=function(){mapChart.addPolygons(countries.features,{name:"countries",style:{fill:chartConfig.landColor,stroke:"white"}});};var getCensusDivision=function(str){if(typeof str==='undefined')return null;var censusDivision=parseInt(censusDivision);if(!isNaN(censusDivision))return censusDivision;str=str.toLowerCase();if(str.indexOf("new england")>-1)return 1;if(str.indexOf("middle atlantic")>-1||str.indexOf("mid atlantic")>-1)return 2;if(str.indexOf("east north central")>-1)return 3;if(str.indexOf("west north central")>-1)return 4;if(str.indexOf("south atlantic")>-1)return 5;if(str.indexOf("east south central")>-1)return 6;if(str.indexOf("west south central")>-1)return 7;if(str.indexOf("mountain")>-1)return 8;if(str.indexOf("pacific")>-1)return 9;return null;};var getMapData=function(callback){var path=config.data.politicalBoundaries;bluewave.utils.getMapData(path,function(mapData){counties=mapData.counties;states=mapData.states;countries=mapData.countries;callback();});};var getData=function(name,callback){if(!bluewave.data)bluewave.data={};if(bluewave.data[name]){callback.apply(this,[bluewave.data[name]]);}
else{bluewave.utils.getData(name,callback);}};var getColor=function(value,colors,breaks){for(var i=0;i<breaks.length-1;i++){var currBreak=breaks[i];var nextBreak=breaks[i+1];var color=colors[i];if(value>=currBreak&&value<nextBreak){return color;}
else{if(value==breaks[breaks.length-1]){return colors[colors.length-1];}}}};var getFillColors=function(){var fillColors=chartConfig.fillColors;if(!fillColors){if(config.colors){fillColors=config.colors["red"];if(!fillColors){for(var key in config.colors){if(config.colors.hasOwnProperty(key)){fillColors=config.colors[key];break;}}}}}
return fillColors;};var getDefaultFillColor=function(){var defaultFillColor=chartConfig.style.landColor;if(!defaultFillColor)defaultFillColor="lightgray";return defaultFillColor;};var Fill=function(data,fillColors){var me=this;var values={};data.forEach(function(d){var key=d[chartConfig.mapLocation];var value=bluewave.chart.utils.parseFloat(d[chartConfig.mapValue]);if(!isNaN(value))values[key]=value;});var numClasses=7;var breaks=getNaturalBreaks(Object.values(values),numClasses);var colorRange=chroma.scale(fillColors);var colors=colorRange.colors(breaks.length-1).reverse();this.getColor=function(key,defaultColor){var value=me.getValue(key);if(isNaN(value)){return defaultColor;}
else{return getColor(value,colors,breaks);}};this.getValue=function(key){return values[key];};};var merge=javaxt.dhtml.utils.merge;var createTable=javaxt.dhtml.utils.createTable;var isArray=javaxt.dhtml.utils.isArray;var addShowHide=javaxt.dhtml.utils.addShowHide;var createDashboardItem=bluewave.utils.createDashboardItem;var addTextEditor=bluewave.utils.addTextEditor;var createSlider=bluewave.utils.createSlider;var getType=bluewave.chart.utils.getType;var parseData=bluewave.utils.parseData;var getNaturalBreaks=bluewave.chart.utils.getNaturalBreaks;init();};
if(!bluewave)var bluewave={};if(!bluewave.editor)bluewave.editor={};bluewave.editor.PieEditor=function(parent,config){var me=this;var defaultConfig={panel:{},colors:bluewave.utils.getColorGradients(),chart:{pieCutout:0.65,piePadding:0,pieSort:"value",pieSortDir:"descending",maximumSlices:0,labelOffset:120,showOther:true,showTooltip:true}};var panel;var inputData=[];var previewArea;var pieChart;var optionsDiv;var pieInputs={};var chartConfig={};var styleEditor;var init=function(){if(!config)config={};config=merge(config,defaultConfig);chartConfig=config.chart;var table=createTable(parent);var tr=table.addRow();var td;me.el=table;td=tr.addColumn();let div=document.createElement("div");div.className="chart-editor-options";td.appendChild(div);optionsDiv=div;td=tr.addColumn();td.className="chart-editor-preview";td.style.width="100%";td.style.height="100%";panel=createDashboardItem(td,{width:"100%",height:"100%",title:"Untitled",settings:true});previewArea=panel.innerDiv;panel.el.className="";addTextEditor(panel.title,function(title){panel.title.innerHTML=title;chartConfig.chartTitle=title;});panel.settings.onclick=function(){if(chartConfig)editStyle();};pieChart=new bluewave.charts.PieChart(previewArea,{});};this.update=function(node){me.clear();var clone={};merge(clone,node.config);merge(clone,config.chart);chartConfig=clone;for(var key in node.inputs){if(node.inputs.hasOwnProperty(key)){var inputNode=node.inputs[key];var data=parseData(inputNode.data,inputNode.config);if(data.length>0)inputData.push(data);else{var inputConfig=inputNode.config;if(inputConfig)inputData.push(inputConfig);}}}
var data=inputData[0];var linksAndQuantity=[];if(data.hasOwnProperty("links")){data=Object.values(data.links);var nodeAndType=[];for(var node in inputData[0].nodes){var nodeType=inputData[0].nodes[node].type;var nodeName=inputData[0].nodes[node].name;var nodeAndTypeEntry={};nodeAndTypeEntry.id=node;nodeAndTypeEntry.type=nodeType;nodeAndTypeEntry.name=nodeName;nodeAndType.push(nodeAndTypeEntry);}
for(var link in inputData[0].links){var linkStartType="";var linkEndType="";var linkEndName="";var linkQuantity=inputData[0].links[link].quantity;for(var entry of nodeAndType){if(link.startsWith(entry.id)){linkStartType=entry.type;}
if(link.endsWith(entry.id)){linkEndType=entry.type;linkEndName=entry.name;}}
var linkFullType=linkStartType+" to "+linkEndName;var linksAndQuantityEntry={};linksAndQuantityEntry.key=linkFullType;linksAndQuantityEntry.value=linkQuantity;linksAndQuantityEntry.sendType=linkStartType;linksAndQuantityEntry.receiveType=linkEndType;var previousEntryIndex=linksAndQuantity.findIndex(entry=>entry.key===linkFullType);if(previousEntryIndex!==-1){linksAndQuantity[previousEntryIndex].value=linksAndQuantity[previousEntryIndex].value+linkQuantity;}
else{linksAndQuantity.push(linksAndQuantityEntry);}}
data=linksAndQuantity.slice();data=data.filter(entry=>entry.key.includes(chartConfig.pieKey));if(chartConfig.pieDirection==="Inbound"){data=data.filter(entry=>entry.receiveType.endsWith(chartConfig.pieKey));}
else{data=data.filter(entry=>entry.sendType.startsWith(chartConfig.pieKey));}
let scData=[];data.forEach(function(entry,index){let scEntry={};if(entry.key.includes(chartConfig.pieKey)){scEntry[chartConfig.pieKey]=entry.key;scEntry[chartConfig.pieValue]=entry.value;}
scData.push(scEntry);});inputData=[scData];}
if(chartConfig.chartTitle){panel.title.innerHTML=chartConfig.chartTitle;}
createOptions(optionsDiv);createPreview();};this.clear=function(){inputData=[];chartConfig={};panel.title.innerHTML="Untitled";optionsDiv.innerHTML="";if(pieChart)pieChart.clear();};this.getConfig=function(){return chartConfig;};this.getChart=function(){return previewArea;};this.renderChart=function(parent){var chart=new bluewave.charts.PieChart(parent,{});chart.update(chartConfig,inputData);return chart;};var createOptions=function(parent){var data=inputData[0];var hasLinks=data.hasOwnProperty("links");var fields;if(hasLinks){data=Object.values(data.links);var nodeTypeList=[];for(var node in data.nodes){var nodeType=data.nodes[node].type;if(nodeTypeList.indexOf(nodeType)===-1){nodeTypeList.push(nodeType);}}
fields=nodeTypeList;}
else{fields=Object.keys(data[0]);}
var valueFields=[];fields.forEach((field)=>{var values=[];data.forEach((d)=>{var val=d[field];values.push(val);});var type=getType(values);if(type=="number"||type=="currency")valueFields.push(field);});var table=createTable(parent);table.style.height="";if(hasLinks){createDropdown(table,"pieKey","Group By","key");createDropdown(table,"pieDirection","Direction","direction");fields.forEach((val)=>{pieInputs.key.add(val,val);});chartConfig.pieValue="quantity";pieInputs.direction.add("Inbound");pieInputs.direction.add("Outbound");pieInputs.direction.setValue(chartConfig.pieDirection,true);}
else{createDropdown(table,"pieKey","Key","key");fields.forEach((val)=>{pieInputs.key.add(val,val);});createDropdown(table,"pieValue","Value","value");valueFields.forEach((field)=>{pieInputs.value.add(field,field);});createDropdown(table,"pieSort","Sort By","sort");pieInputs.sort.add("");pieInputs.sort.add("Key");pieInputs.sort.add("Value");createDropdown(table,"pieSortDir","Sort Direction","sortDir");}
pieInputs.key.setValue(chartConfig.pieKey,true);if(typeof pieInputs.value=="object"){pieInputs.value.setValue(chartConfig.pieValue,true);}};var createDropdown=function(table,chartConfigRef,displayName,inputType){var td;td=table.addRow().addColumn();td.innerHTML=displayName+":";td=table.addRow().addColumn();pieInputs[inputType]=new javaxt.dhtml.ComboBox(td,{style:config.style.combobox,readOnly:true});pieInputs[inputType].clear();pieInputs[inputType].onChange=function(name,value){if(chartConfigRef==="pieSort"){if(value.length>0){chartConfig[chartConfigRef]=value;var dir=pieInputs.sortDir.getValue();if(!dir)dir="Ascending";pieInputs.sortDir.clear();pieInputs.sortDir.add("Ascending");pieInputs.sortDir.add("Descending");pieInputs.sortDir.setValue(dir);}
else{delete chartConfig[chartConfigRef];pieInputs.sortDir.clear();createPreview();}}
else{chartConfig[chartConfigRef]=value;var k=pieInputs.key.getValue();var v=pieInputs.value.getValue();if(k&&v){k=(k+"").trim();v=(v+"").trim();if(k.length>0&&v.length>0){var sortBy=config.chart.pieSort;if(sortBy){pieInputs.sort.setValue(sortBy,true);}
var sortDir=config.chart.pieSortDir;if(sortDir){pieInputs.sortDir.setValue(sortDir,true);}
createPreview();}}}};};var createPreview=function(){onRender(previewArea,function(){pieChart.update(chartConfig,inputData);});};var editStyle=function(){if(!styleEditor){styleEditor=new javaxt.dhtml.Window(document.body,{title:"Edit Style",width:400,valign:"top",modal:false,resizable:false,style:config.style.window});}
var body=styleEditor.getBody();body.innerHTML="";var colorField=bluewave.utils.createColorField({colors:config.colors,style:config.style});var form=new javaxt.dhtml.Form(body,{style:config.style.form,items:[{group:"General",items:[{name:"color",label:"Color",type:colorField},{name:"cutout",label:"Cutout",type:"text"}]},{group:"Slices",items:[{name:"padding",label:"Padding",type:"text"},{name:"maximumSlices",label:"Max Slices",type:"text"},{name:"showOther",label:"Show Other",type:"checkbox",options:[{label:"",value:true}]}]},{group:"Labels",items:[{name:"labels",label:"Show Labels",type:"checkbox",options:[{label:"",value:true}]},{name:"extendLines",label:"Extend Lines",type:"checkbox",options:[{label:"",value:true}]},{name:"labelOffset",label:"Label Offset",type:"text"}]}]});colorField.setValue(JSON.stringify(chartConfig.colors));createSlider("cutout",form,"%");var cutout=Math.round(chartConfig.pieCutout*100.0);form.findField("cutout").setValue(cutout);var labelField=form.findField("labels");var labels=chartConfig.showLabels;labelField.setValue(labels===true?true:false);var extendLinesField=form.findField("extendLines");var extendLines=chartConfig.extendLines;extendLinesField.setValue(extendLines===true?true:false);createSlider("labelOffset",form,"%",0,120,1);var labelOffset=chartConfig.labelOffset;form.findField("labelOffset").setValue(labelOffset);createSlider("padding",form,"%",0,100,1);var padding=chartConfig.piePadding;var maxPadding=5;padding=Math.round((padding/maxPadding)*100.0);form.findField("padding").setValue(padding);var maxSliceOptField=form.findField("showOther");var showOther=chartConfig.showOther;maxSliceOptField.setValue(showOther===true?true:false);var numSlices=inputData[0].length;if(pieChart)numSlices=pieChart.getNumSlices();createSlider("maximumSlices",form,"",1,numSlices,1);var maximumSlices=parseInt(chartConfig.maximumSlices);if(isNaN(maximumSlices)||maximumSlices<1||maximumSlices>numSlices){maximumSlices=numSlices;}
form.findField("maximumSlices").setValue(maximumSlices);form.onChange=function(){var settings=form.getData();chartConfig.pieCutout=settings.cutout/100;chartConfig.piePadding=(settings.padding*maxPadding)/100;var maximumSlices=parseInt(settings.maximumSlices);if(isNaN(maximumSlices)||maximumSlices<1||maximumSlices>numSlices){maximumSlices=numSlices;}
chartConfig.maximumSlices=maximumSlices;if(settings.labels==="true"){settings.labels=true;form.enableField("labelOffset");form.enableField("extendLines");}
else if(settings.labels==="false"){settings.labels=false;form.disableField("labelOffset");form.disableField("extendLines");}
chartConfig.showLabels=settings.labels;chartConfig.extendLines=settings.extendLines==="true";chartConfig.labelOffset=settings.labelOffset;if(settings.showOther==="true")settings.showOther=true;else if(settings.showOther==="false")settings.showOther=false;chartConfig.showOther=settings.showOther;chartConfig.colors=JSON.parse(settings.color);createPreview();};styleEditor.showAt(108,57);form.resize();};var merge=javaxt.dhtml.utils.merge;var onRender=javaxt.dhtml.utils.onRender;var createTable=javaxt.dhtml.utils.createTable;var createDashboardItem=bluewave.utils.createDashboardItem;var createSlider=bluewave.utils.createSlider;var addTextEditor=bluewave.utils.addTextEditor;var getType=bluewave.chart.utils.getType;var parseData=bluewave.utils.parseData;init();};
if(!bluewave)var bluewave={};if(!bluewave.editor)bluewave.editor={};bluewave.editor.SankeyEditor=function(parent,config){var me=this;var defaultConfig={margin:{top:10,right:10,bottom:10,left:10},nodes:[{icon:"fas fa-sign-out-alt",label:"Input"},{icon:"fas fa-random",label:"Distributor"},{icon:"fas fa-sign-in-alt",label:"Output"}],sankey:{style:{links:{color:"#ccc",opacity:0.3}}},hidePreview:false,renderers:{drawflowNodes:createDrawflowNode}};var editPanel,previewPanel,waitmask;var dashboardItem;var toolbar,tooltip,tooltipTimer,lastToolTipEvent;var titleDiv;var button={};var nodes={};var labels={};var quantities={};var drawflow,currModule;var button={};var nodeEditor,linkEditor;var sankeyChart;var toggleButton;var styleEditor;var zoom=0;var callout;var linkMenu;var init=function(){var clone={};merge(clone,config);merge(clone,defaultConfig);config=clone;if(!config.style)config.style=javaxt.dhtml.style.default;waitmask=config.waitmask;if(!waitmask)waitmask={show:function(){},hide:function(){}};var div=document.createElement("div");div.style.height="100%";div.style.position="relative";div.style.overflow="hidden";createToggleButton(div);var innerDiv=document.createElement("div");innerDiv.style.width="100%";innerDiv.style.height="100%";innerDiv.style.position="absolute";div.appendChild(innerDiv);previewPanel=document.createElement("div");previewPanel.style.height="100%";previewPanel.style.textAlign="center";innerDiv.appendChild(previewPanel);addShowHide(previewPanel);createSankey(previewPanel);previewPanel.hide();editPanel=document.createElement("div");editPanel.className="drawflow";editPanel.ondrop=drop;editPanel.ondragover=function(e){e.preventDefault();};editPanel.onwheel=function(e){e.preventDefault();if(drawflow){if(e.deltaY>0){zoomOut();}
else{zoomIn();}}};innerDiv.appendChild(editPanel);createTitle(editPanel);createDrawFlow(editPanel);createToolbar(editPanel);addShowHide(editPanel);parent.appendChild(div);me.el=div;addShowHide(me);};this.onChange=function(){};this.onContextMenu=function(node){};this.onNodeImport=function(node){};this.clear=function(){drawflow.clear();drawflow.removeModule(currModule);currModule=null;setTitle("Untitled",true);sankeyChart.clear();nodes={};quantities={};zoom=0;};this.update=function(node){me.clear();var sankeyConfig=null;var showPreview=false;if(node.inputs){for(var nodeID in node.inputs){if(node.inputs.hasOwnProperty(nodeID)){var n=node.inputs[nodeID];if(n.config.nodes||n.config.links){sankeyConfig=n.config;showPreview=true;break;}}}}
if(!sankeyConfig)sankeyConfig={};merge(sankeyConfig,node.config);sankeyConfig=JSON.parse(JSON.stringify(sankeyConfig));setTitle(sankeyConfig.chartTitle,true);if(!sankeyConfig.style)sankeyConfig.style={};config.sankey.style=merge(sankeyConfig.style,defaultConfig.sankey.style);toggleButton.setValue("Edit");if(config.hidePreview===true)toggleButton.hide();else toggleButton.show();currModule="sankey_"+new Date().getTime();drawflow.addModule(currModule);drawflow.changeModule(currModule);if(sankeyConfig.layout){var data={drawflow:{}};data.drawflow[currModule]={data:sankeyConfig.layout};drawflow.import(data);}
for(var nodeID in sankeyConfig.nodes){if(sankeyConfig.nodes.hasOwnProperty(nodeID)){var drawflowNode=drawflow.getNodeFromId(nodeID);var temp=document.createElement("div");temp.innerHTML=drawflowNode.html;var node=document.getElementById(temp.childNodes[0].id);var props=sankeyConfig.nodes[nodeID];for(var key in props){if(props.hasOwnProperty(key)){var val=props[key];node[key]=val;}}
addEventListeners(node);node.inputs={};for(var key in drawflowNode.inputs){if(drawflowNode.inputs.hasOwnProperty(key)){var connections=drawflowNode.inputs[key].connections;for(var i in connections){var connection=connections[i];var inputID=connection.node;var inputNode=nodes[inputID];node.inputs[inputID]=inputNode;}}}
nodes[nodeID]=node;me.onNodeImport(node,props);}}
for(var nodeID in nodes){var node=nodes[nodeID];for(var inputID in node.inputs){var inputNode=node.inputs[inputID];if(!inputNode)node.inputs[inputID]=nodes[inputID];}}
var connections=editPanel.getElementsByTagName("svg");for(var i=0;i<connections.length;i++){var connection=connections[i];var arr=getInputOutputID(connection);var inputID=arr[0];var outputID=arr[1];var key=inputID+"->"+outputID;var link=sankeyConfig.links[key];quantities[key]=link.quantity;var path=connection.getElementsByTagName("path")[0];path.setAttribute("d",link.path);onSVGRender(path,function(){addLabel(this);});auditLinkages();}
setZoom(sankeyConfig.zoom);if(showPreview){toggleButton.hide();toggleButton.setValue("Preview");}};var addLabel=function(path){var connection=path.parentNode;var arr=getInputOutputID(connection);var key=arr[0]+"->"+arr[1];var label=quantities[key];var l=path.getTotalLength();var p=path.getPointAtLength(l/2);var svg=d3.select(path.parentNode);var g=svg.append("g").attr("transform","translate(-9999,-9999)").on("click",function(){var menu=getLinkMenu();menu.label=d3.select(this);me.showMenu(menu,this);});var temp=svg.append("text").attr("text-anchor","start").text(label);var box=temp.node().getBBox();temp.remove();var w=Math.max(box.width+8,60);var h=box.height;var a=h/2;var x=p.x+a;var y=p.y-a;var vertices=[[x,y],[x+w,y],[x+w,y+h],[x,y+h],[x-a,y+a]];g.append("polygon").attr("points",vertices.join(" ")).style("fill","#459db7");var a=h/3;g.append("text").attr("x",x+a).attr("y",p.y+a).attr("text-anchor","start").style("fill","#fff").text(label);labels[key]=g;};this.getNodes=function(){return nodes;};this.getConfig=function(){var sankeyConfig={layout:currModule?drawflow.export().drawflow[currModule].data:{},nodes:{},links:{},chartTitle:getTitle(),style:config.sankey.style,zoom:zoom};for(var key in sankeyConfig.layout){if(sankeyConfig.layout.hasOwnProperty(key)){var node=sankeyConfig.layout[key];node.html=nodes[key].parentNode.innerHTML;}}
for(var key in nodes){if(nodes.hasOwnProperty(key)){var node=nodes[key];sankeyConfig.nodes[key]={name:node.name,type:node.type,notes:node.notes};for(var k in node){if(node.hasOwnProperty(k)){var val=node[k];var addVal=false;if(typeof val==="string"){addVal=true;}
else{if(isNaN(val)){if(val===true||val===false){addVal=true;}}
else{addVal=true;}}
if(addVal){sankeyConfig.nodes[key][k]=val;}}}}};var connections=editPanel.getElementsByTagName("svg");for(var i=0;i<connections.length;i++){var connection=connections[i];var arr=getInputOutputID(connection);var path=connection.getElementsByTagName("path")[0];if(path)path=path.getAttribute("d");var key=arr[0]+"->"+arr[1];sankeyConfig.links[key]={path:path,quantity:quantities[key]};}
return sankeyConfig;};var getInputOutputID=function(connection){var classes=connection.className;if(classes.baseVal)classes=classes.baseVal;var inputID,outputID;var arr=classes.split(" ");for(var j=0;j<arr.length;j++){var str=arr[j].trim();var idx=str.indexOf("node_in_node");if(idx===0)outputID=str.substring("node_in_node".length+1);var idx=str.indexOf("node_out_node");if(idx===0)inputID=str.substring("node_out_node".length+1);}
return[inputID,outputID];};this.getChart=function(){if(!previewPanel.isVisible())toggleButton.setValue("Preview");return previewPanel;};this.renderChart=function(parent){var chart=new bluewave.charts.SankeyChart(parent,config.sankey);var data=me.getSankeyData();chart.update(config.sankey.style,data);return chart;};this.getEditor=function(){if(previewPanel.isVisible())toggleButton.setValue("Edit");return editPanel;};var setTitle=function(title,silent){if(!title)title="Untitled";dashboardItem.title.innerHTML=title;titleDiv.innerHTML=title;if(silent===true)return;me.onChange();};var getTitle=function(){var title=dashboardItem.title.innerHTML;if(!title)return null;else return title;};var createTitle=function(parent){var div=document.createElement("div");div.style.position="absolute";div.style.width="100%";div.style.textAlign="center";div.style.zIndex=2;parent.appendChild(div);titleDiv=document.createElement("div");titleDiv.className="chart-title noselect";titleDiv.style.display="inline-block";titleDiv.style.backgroundColor="rgba(255,255,255,0.7)";titleDiv.style.padding="5px 10px";div.appendChild(titleDiv);addTextEditor(titleDiv,function(title){setTitle(title);});};var createToolbar=function(parent){toolbar=document.createElement("div");toolbar.className="drawflow-toolbar";parent.appendChild(toolbar);tooltip=new javaxt.dhtml.Callout(document.body,{style:{panel:"tooltip-panel",arrow:"tooltip-arrow"}});var _hideToolTip=tooltip.hide;tooltip.hide=function(){if(tooltipTimer)clearTimeout(tooltipTimer);_hideToolTip();};for(var i=0;i<config.nodes.length;i++){var n=config.nodes[i];createButton(n.icon,n.label);}};var getPreviousNodeValue=function(previousNodeId){var node=nodes[previousNodeId];var inputs=node.inputs;var quantity=0;for(var k in inputs){if(inputs.hasOwnProperty(k)){var v=quantities[k+"->"+previousNodeId];quantity=quantity+v;}}
if(quantity==0){quantity=1;}
return quantity;};var auditNodes=function(){for(var key in nodes){var node=nodes[key];var inputs=node.inputs;var outputs=getOutputs(key);var inputQuantity=0;var outputQuantity=0;for(var k in inputs){if(inputs.hasOwnProperty(k)){var n=nodes[k];var v=quantities[k+"->"+key];inputQuantity=inputQuantity+v;}}
for(var i=0;i<outputs.length;i++){var k=outputs[i];var n=nodes[k];var v=quantities[key+"->"+k];outputQuantity=outputQuantity+v;}
var data=drawflow.drawflow.drawflow[currModule].data;var value=data[key];if(checkInputsAndOutputs(value)&&inputQuantity!=outputQuantity){node.style.color="red";}else{node.style.color="black";}}
auditLinkages();};var getOutputs=function(value){var outputs=[];for(var key in nodes){var n=nodes[key];var inputs=n.inputs;for(var k in inputs){if(value===k){outputs.push(key);}}}
return outputs;};var checkInputsAndOutputs=function(data){if(Object.keys(data.inputs).length===0){return false;}
if(Object.keys(data.outputs).length===0){return false;}
return true;};var auditLinkages=function(){var linkages=editPanel.getElementsByClassName("connection");for(var item of linkages){var classNames=item.classList;var nodeList=[];for(var name of classNames){if(name.includes("node")){nodeList.push(name);}}
var path=item.children[0];checkLinkage(nodeList,path);}};var checkLinkage=function(nodeList,path){var inputID=nodeList[0].substring("node_in_node".length+1);var outputID=nodeList[1].substring("node_out_node".length+1);var nodeIn=nodes[inputID];var nodeOut=nodes[outputID];if(typeof nodeIn!=='undefined'||typeof nodeOut!=='undefined'){if(nodeIn.style.color=="red"||nodeOut.style.color=="red"){path.style.stroke="red";}
else{path.style.stroke="";}}};var createDrawFlow=function(parent){drawflow=new Drawflow(parent);drawflow.reroute=true;drawflow.start();var x,y;drawflow.on('click',function(e){x=e.clientX;y=e.clientY;});drawflow.on('connectionCreated',function(info){var outputID=info.output_id+"";var inputID=info.input_id+"";var key=outputID+"->"+inputID;var node=nodes[inputID];node.inputs[outputID]=nodes[outputID];var value=getPreviousNodeValue(outputID);quantities[key]=value;var connections=editPanel.getElementsByTagName("svg");for(var i=0;i<connections.length;i++){var connection=connections[i];var arr=getInputOutputID(connection);if(arr[1]===inputID&&arr[0]===outputID){var path=connection.getElementsByTagName("path")[0];addLabel(path);break;}}
auditNodes();me.onChange();});drawflow.on('connectionRemoved',function(info){var outputID=info.output_id+"";var inputID=info.input_id+"";var key=outputID+"->"+inputID;var label=labels[key];if(label)label.remove();delete labels[key];delete quantities[key];auditNodes();me.onChange();});drawflow.on('nodeRemoved',function(nodeID){delete nodes[nodeID+""];auditNodes();me.onChange();});drawflow.on('nodeMoved',function(nodeID){for(var key in labels){if(labels.hasOwnProperty(key)){var arr=key.split("->");if(arr[0]===nodeID||arr[1]===nodeID){var label=labels[key];var path=label.node().previousSibling;if(label)label.remove();delete labels[key];addLabel(path);}}}});drawflow.on('contextmenu',function(e){setTimeout(function(){for(var key in nodes){if(nodes.hasOwnProperty(key)){var node=nodes[key];var parentNode=node.parentNode.parentNode;var deleteDiv=parentNode.getElementsByClassName("drawflow-delete")[0];if(deleteDiv){me.onContextMenu(node);parentNode.removeChild(deleteDiv);deleteDiv=document.createElement("div");deleteDiv.className="drawflow-delete2";parentNode.appendChild(deleteDiv);deleteDiv.innerHTML="&#x2715";deleteDiv.onclick=function(){var div=this;confirm("Are you sure you want to delete this node?",{leftButton:{label:"Yes",value:true},rightButton:{label:"No",value:false},callback:function(yes){if(yes){drawflow.removeNodeId(div.parentNode.id);}
else{div.parentNode.removeChild(div);}}});};}}}},200);});};var setZoom=function(z){z=parseInt(z);if(isNaN(z)||z===zoom)return;var d=Math.abs(z,zoom);for(var i=0;i<d;i++){if(z<zoom){zoomOut();}
else{zoomIn();}}};var zoomIn=function(){drawflow.zoom_in();zoom++;};var zoomOut=function(){drawflow.zoom_out();zoom--;};var drag=function(ev){if(ev.type==="touchstart"){}
else{ev.dataTransfer.setData("node",ev.target.getAttribute("data-node"));}};var drop=function(ev){if(ev.type==="touchend"){}
else{ev.preventDefault();let nodeType=ev.dataTransfer.getData("node");addNodeToDrawFlow(nodeType,ev.clientX,ev.clientY);}};var addNodeToDrawFlow=function(nodeType,pos_x,pos_y){if(drawflow.editor_mode==="fixed"){return false;}
pos_x=pos_x*(drawflow.precanvas.clientWidth/(drawflow.precanvas.clientWidth*drawflow.zoom))-
drawflow.precanvas.getBoundingClientRect().x*(drawflow.precanvas.clientWidth/(drawflow.precanvas.clientWidth*drawflow.zoom));pos_y=pos_y*(drawflow.precanvas.clientHeight/(drawflow.precanvas.clientHeight*drawflow.zoom))-
drawflow.precanvas.getBoundingClientRect().y*(drawflow.precanvas.clientHeight/(drawflow.precanvas.clientHeight*drawflow.zoom));var btn=button[nodeType];if(!btn){console.log("Unsupported Node Type: "+nodeType);return;}
var name=btn.el.dataset["title"];var id=0;for(var key in nodes){if(nodes.hasOwnProperty(key)){var node=nodes[key];var type=node.type;if(type===nodeType){id++;}}}
if(id>0)name+=" "+(id+1);var icon=btn.el.dataset["icon"];var i=document.createElement("i");i.className=icon;var numInputs=0;var numOutputs=0;for(var x=0;x<config.nodes.length;x++){var n=config.nodes[x];if(n.label===nodeType){if(x==0){numOutputs=1;}
else if(x==config.nodes.length-1){numInputs=1;}
else{numInputs=1;numOutputs=1;}
break;}}
var node=createNode({name:name,type:nodeType,icon:icon,content:i,position:[pos_x,pos_y],inputs:numInputs,outputs:numOutputs});addEventListeners(node);me.onChange();};var addEventListeners=function(node){node.ondblclick=function(){editNode(this);};};var createDrawflowNode=function(node){var div=document.createElement("div");var title=document.createElement("div");title.className="drawflow-node-title";title.innerHTML="<i class=\""+node.icon+"\"></i><span>"+node.name+"</span>";div.appendChild(title);var body=document.createElement("div");body.className="drawflow-node-body";var content=node.content;if(content){if(typeof content==="string"){body.innerHTML=content;}
else{body.appendChild(content);}}
div.appendChild(body);return div;};var createNode=function(node){var div;if(config.renderers.drawflowNodes){div=config.renderers.drawflowNodes(node);}
else{div=createDrawflowNode(node);}
var nodeID=new Date().getTime();div.id="drawflow_node_"+nodeID;var tempID=drawflow.addNode(node.type,node.inputs,node.outputs,node.position[0],node.position[1],"",{},div.outerHTML);div=document.getElementById(div.id);div.name=node.name;div.type=node.type;div.inputs={};div.outputs={};nodes[nodeID+""]=div;var data=drawflow.drawflow.drawflow[currModule].data;var info=data[tempID];info.id=nodeID;data[nodeID+""]=info;delete data[tempID];var contentNode=div.parentNode;var drawflowNode=contentNode.parentNode;drawflowNode.id="node_"+nodeID;return div;};this.getNodeEditor=function(){if(!nodeEditor){nodeEditor=new javaxt.dhtml.Window(document.body,{title:"Edit Node",width:400,valign:"top",modal:true,resizable:false,style:config.style.window});var form=new javaxt.dhtml.Form(nodeEditor.getBody(),{style:config.style.form,items:[{name:"name",label:"Name",type:"text"},{name:"notes",label:"Notes",type:"textarea"}],buttons:[{name:"Cancel",onclick:function(){cancel();nodeEditor.close();}},{name:"Submit",onclick:function(){var inputs=form.getData();var name=inputs.name;if(name)name=name.trim();if(name==null||name===""){warn("Name is required",nameField);return;}
waitmask.show();checkName(name,nodeEditor.node,function(isValid){waitmask.hide();if(!isValid){warn("Name is not unique",nameField);}
else{submit();}});}}]});var nameField=form.findField("name");var submit=function(){nodeEditor.close();var node=nodeEditor.node;if(!node)return;var data=form.getData();node.name=data.name;node.notes=data.notes;if(node.name){node.name=node.name.trim();if(node.name.length>0){node.childNodes[0].getElementsByTagName("span")[0].innerHTML=node.name;}}};var cancel=function(){var node=nodeEditor.node;if(node){if(node.name)form.setValue("name",node.name);if(node.notes)form.setValue("notes",node.notes);}};nodeEditor.update=function(node){form.clear();if(nameField.resetColor)nameField.resetColor();nodeEditor.node=node;if(node){if(node.name)form.setValue("name",node.name);if(node.notes)form.setValue("notes",node.notes);}};}
return nodeEditor;};var editNode=function(node){var editor=me.getNodeEditor();editor.update(node);editor.show();};var checkName=function(name,currentNode,callback){var isValid=true;for(var key in nodes){if(nodes.hasOwnProperty(key)){var node=nodes[key];var nodeName=node.name;if(node!==currentNode){if(name.toLowerCase()===nodeName.toLowerCase()){isValid=false;break;}}}}
callback.apply(me,[isValid]);};this.getLinkEditor=function(){if(!linkEditor){var link={};linkEditor=new javaxt.dhtml.Window(document.body,{title:"Edit Link",width:400,valign:"top",modal:true,resizable:false,style:config.style.window});var form=new javaxt.dhtml.Form(linkEditor.getBody(),{style:config.style.form,items:[{name:"quantity",label:"Quantity",type:"text"}],buttons:[{name:"Cancel",onclick:function(){linkEditor.close();}},{name:"Submit",onclick:function(){var inputs=form.getData();var quantity=inputs.quantity;if(quantity)quantity=parseFloat(quantity.trim());if(isNaN(quantity)){warn("Quantity is required",quantityField);return;}
quantities[link.from+"->"+link.to]=quantity;link.label.select("text").text(quantity);linkEditor.close();me.onChange();}}]});var quantityField=form.findField("quantity");linkEditor.update=function(label){form.clear();if(quantityField.resetColor)quantityField.resetColor();var connection=label.node().parentNode;var arr=getInputOutputID(connection);link.from=arr[0];link.to=arr[1];link.label=label;var quantity=quantities[link.from+"->"+link.to];quantityField.setValue(quantity);};}
return linkEditor;};var editLink=function(label){var editor=me.getLinkEditor();editor.update(label);editor.show();};var removeLink=function(label){var connection=label.node().parentNode;var arr=getInputOutputID(connection);drawflow.removeSingleConnection(arr[0],arr[1],'output_1','input_1');};var createButton=function(icon,label){var btn=new javaxt.dhtml.Button(toolbar,{display:"table",disabled:false,style:{button:"drawflow-toolbar-button",select:"drawflow-toolbar-button-selected",hover:"drawflow-toolbar-button-hover",label:"drawflow-toolbar-button-label",icon:"drawflow-toolbar-button-icon "+icon}});btn.el.dataset["node"]=label;btn.el.dataset["icon"]=icon;btn.el.dataset["title"]=label;btn.el.draggable=true;btn.el.ondragstart=function(e){if(btn.isDisabled()){return false;}
drag(e);};btn.el.onmouseover=function(e){var button=this;if(tooltipTimer)clearTimeout(tooltipTimer);if(btn.isEnabled()){var showToolTip=function(){var nodeType=button.dataset["node"];var title=button.dataset["title"];var label="Add "+(title==null?nodeType:title);tooltip.getInnerDiv().innerHTML=label;var rect=javaxt.dhtml.utils.getRect(button);var rect2=javaxt.dhtml.utils.getRect(button.parentNode);var x=rect2.x+rect2.width+3;var y=rect.y+Math.ceil(rect.height/2);tooltip.showAt(x,y,"right","center");lastToolTipEvent=new Date().getTime();};var delay=false;if(lastToolTipEvent){if(new Date().getTime()-lastToolTipEvent<3000)delay=false;}
if(delay){tooltipTimer=setTimeout(showToolTip,1000);}
else{showToolTip();}}};btn.el.onmouseleave=function(){tooltip.hide();};btn.el.onmousedown=function(){tooltip.hide();};button[label]=btn;return btn;};var createSankey=function(parent){dashboardItem=createDashboardItem(parent,{width:"1000px",height:"644px",title:"Untitled",settings:true});var div=dashboardItem.el;div.className="dashboard-item";div.style.float="none";addTextEditor(dashboardItem.title,function(title){setTitle(title);});dashboardItem.settings.onclick=function(){editStyle();};sankeyChart=new bluewave.charts.SankeyChart(dashboardItem.innerDiv,config.sankey);};var updateSankey=function(){var data=me.getSankeyData();sankeyChart.update(config.sankey.style,data);};this.getSankeyData=function(){var data={nodes:[],links:[]};for(var key in nodes){if(nodes.hasOwnProperty(key)){var node=nodes[key];var name=node.name;data.nodes.push({name:name,group:node.type});var inputs=node.inputs;for(var k in inputs){if(inputs.hasOwnProperty(k)){var n=nodes[k];var v=quantities[k+"->"+key];data.links.push({source:n.name,target:name,value:v});}}}}
return data;};var editStyle=function(){if(!styleEditor){var win=new javaxt.dhtml.Window(document.body,{title:"Edit Style",width:400,valign:"top",modal:false,resizable:false,style:config.style.window});var linkColor=new javaxt.dhtml.ComboBox(document.createElement("div"),{style:config.style.combobox});linkColor.add("Solid color","#ccc");linkColor.add("Source color","source");var form=new javaxt.dhtml.Form(win.getBody(),{style:config.style.form,items:[{group:"Links",items:[{name:"linkColor",label:"Color",type:linkColor},{name:"linkOpacity",label:"Opacity",type:"text"}]}]});createSlider("linkOpacity",form,"%");styleEditor=form;styleEditor.show=function(){win.show();form.resize();};}
var sankeyStyle=config.sankey.style;styleEditor.onChange=function(){};styleEditor.findField("linkColor").setValue(sankeyStyle.links.color);styleEditor.findField("linkOpacity").setValue(sankeyStyle.links.opacity*100);styleEditor.onChange=function(){var settings=styleEditor.getData();sankeyStyle.links.color=settings.linkColor;sankeyStyle.links.opacity=settings.linkOpacity/100;updateSankey();};styleEditor.show();};var createToggleButton=function(parent){var div=document.createElement("div");div.style.position="absolute";div.style.top="20px";div.style.right="20px";div.style.zIndex=2;parent.appendChild(div);var options=["Edit","Preview"];toggleButton=bluewave.utils.createToggleButton(div,{options:options,defaultValue:options[0],onChange:function(val){if(val==="Edit"){previewPanel.hide();editPanel.show();}
else{editPanel.hide();previewPanel.show();updateSankey();}}});addShowHide(toggleButton);};this.showMenu=function(menu,target){var numVisibleItems=0;for(var i=0;i<menu.childNodes.length;i++){var menuItem=menu.childNodes[i];if(menuItem.isVisible())numVisibleItems++;}
if(numVisibleItems===0){return;}
var callout=me.getCallout();var innerDiv=callout.getInnerDiv();while(innerDiv.firstChild){innerDiv.removeChild(innerDiv.lastChild);}
innerDiv.appendChild(menu);var rect=javaxt.dhtml.utils.getRect(target);var x=rect.x+(rect.width/2);var y=rect.y+rect.height+3;callout.showAt(x,y,"below","right");};var getLinkMenu=function(){if(!linkMenu){var div=document.createElement("div");div.className="app-menu";div.appendChild(createMenuOption("Edit Quantity","edit",function(){editLink(linkMenu.label);}));div.appendChild(createMenuOption("Delete Link","times",function(){removeLink(linkMenu.label);}));linkMenu=div;}
return linkMenu;};var createMenuOption=function(label,icon,onClick){var div=document.createElement("div");div.className="app-menu-item noselect";if(icon&&icon.length>0){div.innerHTML='<i class="fas fa-'+icon+'"></i>'+label;}
else{div.innerHTML=label;}
div.label=label;div.onclick=function(){callout.hide();onClick.apply(this,[label]);};addShowHide(div);return div;};this.getCallout=function(){if(callout){var parent=callout.el.parentNode;if(!parent){callout.el.innerHTML="";callout=null;}}
if(!callout)callout=new javaxt.dhtml.Callout(document.body,{style:config.style.callout});return callout;};var onSVGRender=function(el,callback){var bbox=el.getBBox();var w=bbox.width;if(w===0||isNaN(w)){var timer;var checkWidth=function(){var bbox=el.getBBox();var w=bbox.width;if(w===0||isNaN(w)){timer=setTimeout(checkWidth,100);}
else{clearTimeout(timer);if(callback)callback.apply(el,[bbox]);}};timer=setTimeout(checkWidth,100);}
else{if(callback)callback.apply(el,[bbox]);}};var merge=javaxt.dhtml.utils.merge;var addShowHide=javaxt.dhtml.utils.addShowHide;var createDashboardItem=bluewave.utils.createDashboardItem;var addTextEditor=bluewave.utils.addTextEditor;var createSlider=bluewave.utils.createSlider;var warn=bluewave.utils.warn;init();};
if(!bluewave)var bluewave={};if(!bluewave.editor)bluewave.editor={};bluewave.editor.ScatterEditor=function(parent,config){var me=this;var defaultConfig={panel:{},chart:{pointColor:"#6699cc",pointRadius:7,pointOpacity:0.8,showRegLine:false,showTooltip:true}};var panel;var inputData=[];var previewArea;var scatterChart;var optionsDiv;var plotInputs={};var chartConfig={};var styleEditor;var colorPicker;var init=function(){if(!config)config={};config=merge(config,defaultConfig);chartConfig=config.chart;let table=createTable();let tbody=table.firstChild;var tr=document.createElement("tr");tbody.appendChild(tr);parent.appendChild(table);me.el=table;var td;td=document.createElement("td");tr.appendChild(td);let div=document.createElement("div");div.className="chart-editor-options";td.appendChild(div);optionsDiv=div;td=document.createElement("td");td.className="chart-editor-preview";td.style.width="100%";td.style.height="100%";tr.appendChild(td);panel=createDashboardItem(td,{width:"100%",height:"100%",title:"Scatter Chart",settings:true});previewArea=panel.innerDiv;panel.el.className="";addTextEditor(panel.title,function(title){panel.title.innerHTML=title;chartConfig.chartTitle=title;});panel.settings.onclick=function(){editChart();};scatterChart=new bluewave.charts.ScatterChart(previewArea,{});};this.update=function(node){me.clear();var clone={};merge(clone,node.config);merge(clone,config.chart);chartConfig=clone;for(var key in node.inputs){if(node.inputs.hasOwnProperty(key)){var inputNode=node.inputs[key];var data=parseData(inputNode.data,inputNode.config);if(data.length>0)inputData.push(data);}}
if(chartConfig.chartTitle){panel.title.innerHTML=chartConfig.chartTitle;}
createOptions(optionsDiv);};this.clear=function(){inputData=[];chartConfig={};panel.title.innerHTML="Untitled";optionsDiv.innerHTML="";if(scatterChart)scatterChart.clear();if(colorPicker)colorPicker.hide();};this.getConfig=function(){return chartConfig;};this.getChart=function(){return previewArea;};this.renderChart=function(parent){var chart=new bluewave.charts.ScatterChart(parent,{});chart.update(chartConfig,inputData);return chart;};var createOptions=function(parent){var table=createTable();var tbody=table.firstChild;table.style.height="";parent.appendChild(table);createDropdown(tbody,"xAxis","X-Axis",createScatterPreview);createDropdown(tbody,"yAxis","Y-Axis",createScatterPreview);var data=inputData[0];let dataOptions=Object.keys(data[0]);dataOptions.forEach((val)=>{plotInputs.xAxis.add(val,val);plotInputs.yAxis.add(val,val);});plotInputs.xAxis.setValue(chartConfig.xAxis,false);plotInputs.yAxis.setValue(chartConfig.yAxis,false);};var createDropdown=function(tbody,inputType,displayName,callBack){var tr,td;tr=document.createElement("tr");tbody.appendChild(tr);td=document.createElement("td");tr.appendChild(td);td.innerHTML=displayName+":";tr=document.createElement("tr");tbody.appendChild(tr);td=document.createElement("td");tr.appendChild(td);plotInputs[inputType]=new javaxt.dhtml.ComboBox(td,{style:config.style.combobox,readOnly:true});plotInputs[inputType].onChange=function(name,value){chartConfig[inputType]=value;callBack();};};var createScatterPreview=function(){scatterChart.update(chartConfig,inputData);};var editChart=function(){if(!styleEditor){styleEditor=new javaxt.dhtml.Window(document.body,{title:"Edit Style",width:400,valign:"top",modal:false,resizable:false,style:config.style.window});}
var body=styleEditor.getBody();body.innerHTML="";var xMinDropdown=new javaxt.dhtml.ComboBox(document.createElement("div"),{style:config.style.combobox,readOnly:false});var xKeys=[];inputData.forEach(function(data,i){var n=i>0?(i+1):"";let xAxisN=`xAxis${n}`;var xAxis=chartConfig[xAxisN];if(xAxis){data.forEach((d)=>{xKeys.push(d[xAxis]);});}});var xType=getType(xKeys);if(xType=="number"||xType=="currency"){var minX=Number.MAX_VALUE;var maxX=0;xKeys.forEach((key)=>{var n=bluewave.chart.utils.parseFloat(key);minX=Math.min(n,minX);maxX=Math.max(n,maxX);});xMinDropdown.add("0",0);if(minX!=0)xMinDropdown.add(minX+"",minX);xMinDropdown.setValue(0);}
var form=new javaxt.dhtml.Form(body,{style:config.style.form,items:[{group:"General",items:[{name:"pointLabels",label:"Display Point Labels",type:"checkbox",options:[{label:"",value:true,}]}]},{group:"Analysis",items:[{name:"showRegLine",label:"Enable Regression Line",type:"checkbox",options:[{label:"",value:true,}]},]},{group:"Points",items:[{name:"pointColor",label:"Color",type:new javaxt.dhtml.ComboBox(document.createElement("div"),{style:config.style.combobox})},{name:"pointOpacity",label:"Point Opacity",type:"text"},{name:"pointRadius",label:"Radius",type:"text"}]},{group:"X-Axis",items:[{name:"xLabel",label:"Show Labels",type:"checkbox",options:[{label:"",value:true}]},{name:"xGrid",label:"Show Grid Lines",type:"checkbox",options:[{label:"",value:true}]},{name:"xMin",label:"Min Value",type:xMinDropdown}]},{group:"Y-Axis",items:[{name:"yLabel",label:"Show Labels",type:"checkbox",options:[{label:"",value:true}]},{name:"yGrid",label:"Show Grid Lines",type:"checkbox",options:[{label:"",value:true}]}]}]});var xGridField=form.findField("xGrid");var xGrid=chartConfig.xGrid;xGridField.setValue(xGrid===true?true:false);var yGridField=form.findField("yGrid");var yGrid=chartConfig.yGrid;yGridField.setValue(yGrid===true?true:false);var xLabelField=form.findField("xLabel");var xLabel=chartConfig.xLabel;xLabelField.setValue(xLabel?true:false);var yLabelField=form.findField("yLabel");var yLabel=chartConfig.yLabel;yLabelField.setValue(yLabel?true:false);var tagField=form.findField("pointLabels");var pointLabels=chartConfig.showPointLabels;tagField.setValue(pointLabels===true?true:false);createColorOptions("pointColor",form);form.findField("pointColor").setValue(chartConfig.pointColor);createSlider("pointRadius",form,"px",0,20,1);var pointRadius=parseInt(chartConfig.pointRadius);if(isNaN(pointRadius)||pointRadius<1){pointRadius=defaultConfig.chart.pointRadius;}
form.findField("pointRadius").setValue(pointRadius);createSlider("pointOpacity",form,"%");var pointOpacity=parseFloat(chartConfig.pointOpacity);if(isNaN(pointOpacity)||pointOpacity<0||pointOpacity>100){pointOpacity=defaultConfig.chart.pointOpacity;}
form.findField("pointOpacity").setValue(round(pointOpacity*100,0));form.onChange=function(){var settings=form.getData();chartConfig.pointColor=settings.pointColor;chartConfig.pointOpacity=settings.pointOpacity/100;chartConfig.pointRadius=settings.pointRadius;if(settings.xGrid==="true")settings.xGrid=true;else settings.xGrid=false;if(settings.yGrid==="true")settings.yGrid=true;else settings.yGrid=false;if(settings.xLabel==="true")settings.xLabel=chartConfig.xAxis;else settings.xLabel=null;if(settings.yLabel==="true")settings.yLabel=chartConfig.yAxis;else settings.yLabel=null;if(settings.pointLabels==="true")settings.pointLabels=true;else settings.pointLabels=false;if(settings.showRegLine==="true")settings.showRegLine=true;else settings.showRegLine=false;chartConfig.xGrid=settings.xGrid;chartConfig.yGrid=settings.yGrid;chartConfig.xLabel=settings.xLabel;chartConfig.yLabel=settings.yLabel;chartConfig.pointLabels=settings.pointLabels;chartConfig.showRegLine=settings.showRegLine;var xMin=bluewave.chart.utils.parseFloat(xMinDropdown.getText());if(!isNaN(xMin))chartConfig.xMin=xMin;createScatterPreview();};styleEditor.showAt(108,57);form.resize();};var createColorOptions=function(inputName,form){bluewave.utils.createColorOptions(inputName,form,function(colorField){if(!colorPicker)colorPicker=bluewave.utils.createColorPickerCallout(config);var rect=javaxt.dhtml.utils.getRect(colorField.row);var x=rect.x+rect.width+15;var y=rect.y+(rect.height/2);colorPicker.showAt(x,y,"right","middle");colorPicker.setColor(colorField.getValue());colorPicker.onChange=function(color){colorField.setValue(color);};});};var merge=javaxt.dhtml.utils.merge;var createTable=javaxt.dhtml.utils.createTable;var createDashboardItem=bluewave.utils.createDashboardItem;var createSlider=bluewave.utils.createSlider;var addTextEditor=bluewave.utils.addTextEditor;var round=javaxt.dhtml.utils.round;var getType=bluewave.chart.utils.getType;var parseData=bluewave.utils.parseData;init();};
if(!bluewave)var bluewave={};if(!bluewave.editor)bluewave.editor={};bluewave.editor.TreeMapEditor=function(parent,config){var me=this;var defaultConfig={panel:{},chart:{showTooltip:true,shape:"circle"}};var panel;var inputData=[];var previewArea;var treeMapChart;var optionsDiv;var treeMapInputs={};var chartConfig={};var styleEditor;var init=function(){if(!config)config={};config=merge(config,defaultConfig);chartConfig=config.chart;let table=createTable(parent);var tr=table.addRow();me.el=table;var td;td=tr.addColumn();let div=document.createElement("div");div.className="chart-editor-options";td.appendChild(div);optionsDiv=div;td=tr.addColumn();td.className="chart-editor-preview";td.style.width="100%";td.style.height="100%";panel=createDashboardItem(td,{width:"100%",height:"100%",title:"Untitled",settings:true});previewArea=panel.innerDiv;treeMapChart=new bluewave.charts.TreeMapChart(previewArea,{});treeMapChart.onClick=function(rect,data){editGroup(treeMapChart.getGroup(data.group));};panel.el.className="";addTextEditor(panel.title,function(title){panel.title.innerHTML=title;chartConfig.chartTitle=title;});panel.settings.onclick=function(){if(chartConfig)editStyle();};};this.update=function(node){me.clear();var clone={};merge(clone,node.config);merge(clone,config.chart);chartConfig=clone;for(var key in node.inputs){if(node.inputs.hasOwnProperty(key)){var inputNode=node.inputs[key];var data=parseData(inputNode.data,inputNode.config);if(data.length>0)inputData.push(data);}}
if(chartConfig.chartTitle){panel.title.innerHTML=chartConfig.chartTitle;}
createOptions(optionsDiv);createPreview();};this.clear=function(){inputData=[];chartConfig={};panel.title.innerHTML="Untitled";optionsDiv.innerHTML="";if(treeMapChart)treeMapChart.clear();};this.getConfig=function(){return chartConfig;};this.getChart=function(){return previewArea;};this.renderChart=function(parent){var chart=new bluewave.charts.TreeMapChart(parent,{});chart.update(chartConfig,inputData[0]);return chart;};var createOptions=function(parent){var data=inputData[0];var fields=Object.keys(data[0]);var keyFields=[];var valueFields=[];var groupByFields=[];fields.forEach((field)=>{var values=[];data.forEach((d)=>{var val=d[field];values.push(val);});var type=getType(values);if(type=="string")keyFields.push(field);if(type=="number"||type=="currency")valueFields.push(field);if(type=="string")groupByFields.push(field);});var table=createTable(parent);table.style.height="";createDropdown(table,"Key","key");createDropdown(table,"Value","value");createDropdown(table,"Group By","groupBy");keyFields.forEach((field)=>{treeMapInputs.key.add(field,field);});valueFields.forEach((field)=>{treeMapInputs.value.add(field,field);});groupByFields.forEach((field)=>{treeMapInputs.groupBy.add(field,field);});if(!chartConfig.key)chartConfig.key=keyFields[0];treeMapInputs.key.setValue(chartConfig.key,true);if(!chartConfig.value)chartConfig.value=valueFields[0];treeMapInputs.value.setValue(chartConfig.value,true);if(chartConfig.groupBy){treeMapInputs.groupBy.setValue(chartConfig.groupBy,true);}};var createDropdown=function(table,label,inputType){var td;td=table.addRow().addColumn();td.innerHTML=label+":";td=table.addRow().addColumn();treeMapInputs[inputType]=new javaxt.dhtml.ComboBox(td,{style:config.style.combobox,readOnly:true});treeMapInputs[inputType].onChange=function(name,value){chartConfig[inputType]=value;createPreview();};};var createPreview=function(){if(chartConfig.key&&chartConfig.value){var data=inputData[0];treeMapChart.update(chartConfig,data);}};var editStyle=function(){if(!styleEditor){styleEditor=new javaxt.dhtml.Window(document.body,{title:"Edit Style",width:400,valign:"top",modal:false,resizable:false,style:config.style.window});}
var body=styleEditor.getBody();body.innerHTML="";var shapeDropdown=new javaxt.dhtml.ComboBox(document.createElement("div"),{style:config.style.combobox,readOnly:true});shapeDropdown.add("Circular","circle");shapeDropdown.add("Rectangular","square");shapeDropdown.setValue("circle");var form=new javaxt.dhtml.Form(body,{style:config.style.form,items:[{group:"General",items:[{name:"shape",label:"Shape",type:shapeDropdown}]},{group:"Labels",items:[{name:"groupLabel",label:"Show Group",type:"checkbox",options:[{label:"",value:true}]},{name:"keyLabel",label:"Show Key",type:"checkbox",options:[{label:"",value:true}]},{name:"valueLabel",label:"Show Value",type:"checkbox",options:[{label:"",value:true}]}]}]});var shapeField=form.findField("shape");var shape=chartConfig.shape;shapeField.setValue(shape==="square"?"square":"circle");var groupLabelField=form.findField("groupLabel");var groupLabel=chartConfig.groupLabel;groupLabelField.setValue(groupLabel===true?true:false);var keyLabelField=form.findField("keyLabel");var keyLabel=chartConfig.keyLabel;keyLabelField.setValue(keyLabel===true?true:false);var valueLabelField=form.findField("valueLabel");var valueLabel=chartConfig.valueLabel;valueLabelField.setValue(valueLabel===true?true:false);form.onChange=function(){var settings=form.getData();if(settings.groupLabel==="true")settings.groupLabel=true;else settings.groupLabel=false;if(settings.valueLabel==="true")settings.valueLabel=true;else settings.valueLabel=false;if(settings.keyLabel==="true")settings.keyLabel=true;else settings.keyLabel=false;chartConfig.groupLabel=settings.groupLabel;chartConfig.keyLabel=settings.keyLabel;chartConfig.valueLabel=settings.valueLabel;chartConfig.shape=settings.shape;createPreview();};styleEditor.showAt(108,57);form.resize();};var editGroup=function(arr){if(!arr||arr.length==0)return;};var merge=javaxt.dhtml.utils.merge;var onRender=javaxt.dhtml.utils.onRender;var createTable=javaxt.dhtml.utils.createTable;var createDashboardItem=bluewave.utils.createDashboardItem;var addTextEditor=bluewave.utils.addTextEditor;var getType=bluewave.chart.utils.getType;var parseData=bluewave.utils.parseData;init();};